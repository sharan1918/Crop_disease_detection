<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgriQuest | Command Center</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');

        :root {
            --p: #2563EB;
            --brand-red: #E10000;
            --brand-red-dark: #A50000;
            --l-bg: #F8FAFC;
            --d-bg: #020617;
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            transition: 0.3s;
            margin: 0;
            overflow-x: hidden;
        }

        body.light {
            background: var(--l-bg);
            color: #0F172A;
        }

        body.dark {
            background: var(--d-bg);
            color: #F8FAFC;
        }

        .sidebar {
            width: 280px;
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            border-right: 1px solid;
            z-index: 100;
            display: flex;
            flex-direction: column;
        }

        body.light .sidebar {
            background: #FFF;
            border-color: #E2E8F0;
        }

        body.dark .sidebar {
            background: #0F172A;
            border-color: #1E293B;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 14px 20px;
            margin: 6px 16px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            opacity: 0.7;
            transition: 0.2s;
        }

        .nav-item:hover {
            opacity: 1;
            background: rgba(37, 99, 235, 0.1);
        }

        .nav-item.active {
            opacity: 1;
            background: var(--p);
            color: #FFF !important;
            box-shadow: 0 4px 10px rgba(37, 99, 235, 0.3);
        }

        .content {
            margin-left: 280px;
            padding: 40px;
            min-height: 100vh;
        }

        /* THEME SWITCHER (MOBILE STYLE) */
        .theme-switch {
            width: 64px;
            height: 32px;
            border-radius: 50px;
            position: relative;
            cursor: pointer;
            display: flex;
            align-items: center;
            padding: 4px;
            transition: 0.3s;
            border: 2px solid;
        }

        body.light .theme-switch {
            background: #E2E8F0;
            border-color: #CBD5E1;
            justify-content: flex-start;
        }

        body.dark .theme-switch {
            background: #1E293B;
            border-color: #334155;
            justify-content: flex-end;
        }

        .switch-circle {
            width: 20px;
            height: 20px;
            border-radius: 50px;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            color: #2563EB;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        body.dark .switch-circle {
            background: #FBBF24;
            color: #000;
        }

        /* HERO CAROUSEL (GLANCE STYLE) */
        .hero-box {
            width: 100%;
            height: 380px;
            border-radius: 36px;
            overflow: hidden;
            position: relative;
            margin-bottom: 40px;
        }

        .hero-slides {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
        }

        .hero-slide,
        .activities-slide {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            opacity: 0;
            transition: opacity 1.5s ease-in-out;
        }

        .hero-slide.active,
        .activities-slide.active {
            opacity: 1;
        }

        .hero-overlay {
            position: absolute;
            inset: 0;
            background: linear-gradient(to top, rgba(0, 0, 0, 0.85), transparent);
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            padding: 40px;
            z-index: 10;
        }

        .card {
            border-radius: 28px;
            border: 1px solid;
            padding: 24px;
            transition: 0.3s;
            background: transparent;
        }

        body.light .card {
            background: #FFF;
            border-color: #E2E8F0;
        }

        body.dark .card {
            background: rgba(15, 23, 42, 0.8);
            border-color: rgba(30, 41, 59, 0.5);
            backdrop-filter: blur(12px);
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.05);
        }

        .ticker {
            overflow: hidden;
            white-space: nowrap;
            padding: 12px 0;
            border-bottom: 1px solid;
            margin-bottom: 40px;
        }

        .mask-gradient-left {
            -webkit-mask-image: linear-gradient(to left, black 50%, transparent 100%);
            mask-image: linear-gradient(to left, black 50%, transparent 100%);
        }

        body.light .ticker {
            background: #F1F5F9;
            border-color: #E2E8F0;
        }

        body.dark .ticker {
            background: #0A0C10;
            border-color: #1E293B;
        }

        .ticker-move {
            display: inline-block;
            animation: tick 40s linear infinite;
        }

        @keyframes tick {
            0% {
                transform: translateX(100%);
            }

            100% {
                transform: translateX(-100%);
            }
        }

        input,
        select {
            width: 100%;
            padding: 14px;
            border-radius: 14px;
            border: 1px solid;
            background: transparent;
            color: inherit;
            font-weight: 600;
            outline: none;
        }

        body.light input,
        body.light select {
            border-color: #CBD5E1;
            background-color: #FFFFFF;
            color: #0F172A;
        }

        body.dark input,
        body.dark select {
            border-color: #334155;
            background-color: #1E293B;
            color: #F8FAFC;
        }

        /* Fix for dropdown options visibility */
        select option {
            background-color: inherit;
            color: #000;
        }

        body.dark select option {
            background-color: #1E293B;
            color: #F8FAFC;
        }

        #res-page {
            position: relative;
        }

        .res-theme-float {
            position: absolute;
            top: 24px;
            right: 24px;
            z-index: 50;
        }

        .scan-mode-btn {
            border: none;
            cursor: pointer;
            color: #64748b;
            font-weight: 900 !important;
        }

        .scan-mode-btn.active {
            background: #2563eb !important;
            color: white !important;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.2);
        }

        .hidden {
            display: none !important;
        }

        /* DREAM 11 STYLE AUTH */
        .auth-card {
            background: #FFFFFF;
            border-radius: 40px 40px 0 0;
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .auth-active .auth-card {
            transform: translateY(0);
        }

        @media (min-width: 640px) {
            .auth-card {
                border-radius: 40px;
                transform: scale(0.9);
                opacity: 0;
                transition: all 0.3s ease;
            }

            .auth-active .auth-card {
                transform: scale(1);
                opacity: 1;
            }

            #locationModal .relative {
                transform: scale(0.9);
                opacity: 0;
                transition: all 0.3s ease;
            }

            .location-active #locationModal .relative {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* üõ∞Ô∏è AGRI-RADAR STYLES */
        .radar-container {
            position: relative;
            width: 100%;
            height: 600px;
            background: #0B1120;
            border-radius: 40px;
            overflow: hidden;
            border: 2px solid rgba(255, 255, 255, 0.05);
        }

        .radar-map {
            position: absolute;
            inset: 0;
            background-image: url('https://images.unsplash.com/photo-1500382017468-9049fed747ef?auto=format&fit=crop&q=80&w=2000');
            background-size: cover;
            opacity: 0.25;
            filter: grayscale(0.5) contrast(1.2);
            transition: 0.5s;
        }

        body.light .radar-map {
            opacity: 0.6;
            filter: grayscale(0.2) contrast(1);
        }

        .radar-sweep {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 250%;
            height: 250%;
            background: conic-gradient(from 0deg, rgba(37, 99, 235, 0.4) 0%, transparent 25%);
            transform: translate(-50%, -50%);
            animation: sweep 6s linear infinite;
            pointer-events: none;
            z-index: 5;
        }

        @keyframes sweep {
            100% {
                transform: translate(-50%, -50%) rotate(360deg);
            }
        }

        .radar-point {
            position: absolute;
            width: 14px;
            height: 14px;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            cursor: pointer;
            z-index: 20;
            transition: 0.3s;
        }

        .radar-point::after {
            content: '';
            position: absolute;
            inset: -10px;
            border-radius: 50%;
            border: 2px solid currentColor;
            animation: ping-radar 2.5s ease-out infinite;
        }

        @keyframes ping-radar {
            0% {
                transform: scale(1);
                opacity: 1;
            }

            100% {
                transform: scale(4);
                opacity: 0;
            }
        }

        .radar-grid {
            position: absolute;
            inset: 0;
            background-image: linear-gradient(rgba(255, 255, 255, 0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.05) 1px, transparent 1px);
            background-size: 50px 50px;
            z-index: 2;
        }

        .radar-label {
            position: absolute;
            padding: 8px 12px;
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            color: white;
            font-size: 9px;
            font-weight: 800;
            text-transform: uppercase;
            pointer-events: none;
            opacity: 0;
            transition: 0.3s;
            z-index: 30;
            white-space: nowrap;
        }

        .radar-point:hover+.radar-label,
        .radar-label:hover {
            opacity: 1;
            transform: translateY(-5px);
        }
    </style>
</head>

<body class="light">

    <!-- SIDEBAR -->
    <aside class="sidebar">
        <div class="px-8 py-10 flex-1 flex flex-col min-h-0">
            <div class="flex items-center gap-3 mb-10 flex-shrink-0">
                <div
                    class="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center text-white text-xl shadow-lg">
                    <i class="fas fa-leaf"></i>
                </div>
                <h1 class="text-2xl font-black">AgriQuest</h1>
            </div>
            <nav class="space-y-1 flex-1 overflow-y-auto custom-scrollbar pr-2 mb-8">
                <div class="nav-item active" onclick="setView('dashboard')" id="nav-dashboard">
                    <i class="fas fa-house w-7"></i><span>Overview</span>
                </div>
                <div class="nav-item" onclick="setView('scan')" id="nav-scan">
                    <i class="fas fa-camera w-7"></i><span>Disease Scan</span>
                </div>
                <div class="nav-item" onclick="setView('yield')" id="nav-yield">
                    <i class="fas fa-chart-pie w-7"></i><span>Yield Forecast</span>
                </div>
                <div class="nav-item" onclick="setView('history')" id="nav-history">
                    <i class="fas fa-clock-rotate-left w-7"></i><span>History</span>
                </div>
                <div class="nav-item" onclick="setView('markets')" id="nav-markets">
                    <i class="fas fa-shop w-7"></i><span>Mandi Markets</span>
                </div>
                <div class="nav-item" onclick="setView('radar')" id="nav-radar">
                    <i class="fas fa-satellite w-7 text-indigo-500"></i><span>Agri-Radar</span>
                </div>
                <div class="nav-item" onclick="setView('expert')" id="nav-expert">
                    <i class="fas fa-user-doctor w-7"></i><span>Expert Corner</span>
                </div>
                <div class="nav-item" onclick="setView('activities')" id="nav-activities">
                    <i class="fas fa-certificate w-7"></i><span>Activities</span>
                </div>

                <div class="nav-item" onclick="setView('settings')" id="nav-settings">
                    <i class="fas fa-cog w-7"></i><span>Settings</span>
                </div>
            </nav>

            <!-- WEATHER WIDGET (Sidebar) -->
            <div
                class="p-6 rounded-[32px] bg-gradient-to-br from-blue-600/10 to-transparent border border-blue-500/10 group mt-auto flex-shrink-0">
                <div class="flex justify-between items-start mb-6">
                    <div id="side-wIcon" class="text-3xl"><i class="fas fa-cloud-sun text-amber-500 animate-pulse"></i>
                    </div>
                    <div class="text-right">
                        <p id="side-wTemp" class="text-2xl font-black">--¬∞C</p>
                        <p id="side-wLoc" class="text-[9px] font-bold opacity-40 uppercase">Detecting...</p>
                    </div>
                </div>
                <div class="space-y-4">
                    <div class="flex justify-between items-center text-[10px] font-bold">
                        <span class="opacity-40 uppercase">Humidity</span>
                        <span id="side-wHum">--%</span>
                    </div>
                    <div class="flex justify-between items-center text-[10px] font-bold">
                        <span class="opacity-40 uppercase">Rain Prob.</span>
                        <span id="side-wRain">--%</span>
                    </div>
                </div>
                <button onclick="updateWeather()"
                    class="w-full mt-6 py-3 rounded-2xl bg-white/5 border border-white/10 text-[9px] font-black uppercase tracking-widest hover:bg-blue-600 hover:text-white transition-all group-hover:scale-105">Refresh
                    Hub</button>
            </div>
        </div>
    </aside>

    <!-- CONTENT -->
    <main class="content">
        <!-- HEADER -->
        <header class="flex justify-between items-center mb-8">
            <div>
                <p class="text-[10px] uppercase font-bold tracking-widest opacity-40 mb-1" id="path">Main Hub</p>
                <h2 class="text-4xl font-black" id="v-title">Dashboard</h2>
            </div>

            <div class="flex items-center gap-6">
                <!-- THEME SWITCHER -->
                <div class="theme-switch" onclick="toggleMode()">
                    <div class="switch-circle">
                        <i class="fas fa-sun dark:hidden"></i>
                        <i class="fas fa-moon hidden dark:block"></i>
                    </div>
                </div>

                <!-- AUTH SECTION -->
                <div id="authSection" class="relative group">
                    <div onclick="toggleAuthModal()"
                        class="flex items-center gap-3 px-4 py-2 rounded-2xl bg-slate-100 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 cursor-pointer hover:bg-white dark:hover:bg-slate-700 transition-all shadow-sm">
                        <div class="w-8 h-8 rounded-xl bg-blue-600 flex items-center justify-center text-white text-xs">
                            <i class="fas fa-user"></i>
                        </div>
                        <span id="userName" class="text-xs font-black uppercase tracking-widest">Login / Join</span>
                    </div>
                    <div id="userMenu" class="hidden absolute right-0 mt-3 w-48 card p-2 z-[200]">
                        <button onclick="logout()"
                            class="w-full text-left px-4 py-3 rounded-xl hover:bg-red-50 dark:hover:bg-red-950/20 text-red-600 font-bold text-xs flex items-center gap-2">
                            <i class="fas fa-sign-out-alt"></i> Sign Out
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- TICKER -->
        <div class="ticker rounded-2xl overflow-hidden relative group">
            <div
                class="absolute inset-y-0 left-0 w-20 bg-gradient-to-r from-slate-50 dark:from-slate-950 to-transparent z-10">
            </div>
            <div
                class="absolute inset-y-0 right-0 w-20 bg-gradient-to-l from-slate-50 dark:from-slate-950 to-transparent z-10">
            </div>
            <div class="ticker-move flex gap-20 py-1">
                <span class="text-[10px] font-black uppercase flex items-center gap-2"><i
                        class="fas fa-chart-line text-green-500"></i> Maize (MH): <span
                        class="text-blue-500">‚Çπ2,240</span> <span class="text-green-500">(+1.2%)</span></span>
                <span class="text-[10px] font-black uppercase flex items-center gap-2"><i
                        class="fas fa-chart-line text-red-500"></i> Tomato (KA): <span
                        class="text-blue-500">‚Çπ1,850</span> <span class="text-red-500">(-2.4%)</span></span>
                <span class="text-[10px] font-black uppercase flex items-center gap-2"><i
                        class="fas fa-chart-line text-green-500"></i> Wheat (UP): <span
                        class="text-blue-500">‚Çπ2,125</span> <span class="text-green-500">(+0.8%)</span></span>
                <span class="text-[10px] font-black uppercase flex items-center gap-2"><i
                        class="fas fa-chart-line text-green-500"></i> Onion (NSK): <span
                        class="text-blue-500">‚Çπ1,420</span> <span class="text-green-500">(+5.1%)</span></span>
                <span class="text-[10px] font-black uppercase flex items-center gap-2"><i
                        class="fas fa-chart-line text-blue-500"></i> Rice (PB): <span
                        class="text-blue-500">‚Çπ3,450</span> <span class="opacity-40">(Stable)</span></span>
            </div>
        </div>

        <!-- DASHBOARD -->
        <section id="view-dashboard">
            <!-- OVERVIEW HEADER BANNER -->
            <div
                class="card p-8 bg-gradient-to-br from-blue-600 to-indigo-700 text-white border-none shadow-xl relative overflow-hidden mb-8">
                <div class="absolute right-0 top-0 w-1/3 h-full opacity-10 pointer-events-none">
                    <i class="fas fa-seedling text-[200px] -rotate-12 translate-x-20"></i>
                </div>
                <div class="relative z-10 flex items-center gap-6">
                    <div
                        class="w-16 h-16 rounded-3xl bg-white/20 flex items-center justify-center text-3xl shadow-lg backdrop-blur">
                        <i class="fas fa-house"></i>
                    </div>
                    <div>
                        <h3 class="text-3xl font-black uppercase tracking-tight mb-1">Farm Overview</h3>
                        <p class="opacity-80 font-bold uppercase text-[11px] tracking-[4px]">AgriQuest &bull; Live
                            Dashboard Intelligence</p>
                    </div>
                </div>
            </div>

            <!-- HERO CAROUSEL -->
            <div class="hero-box shadow-2xl">
                <div class="hero-slides">
                    <img src="https://images.unsplash.com/photo-1500382017468-9049fed747ef?auto=format&fit=crop&q=80&w=1200"
                        class="hero-slide active">
                    <img src="https://images.unsplash.com/photo-1523348837708-15d4a09cfac2?auto=format&fit=crop&q=80&w=1200"
                        class="hero-slide">
                    <!-- Removed the 3rd image that had a white background/wasn't loading well -->
                    <img src="https://images.unsplash.com/photo-1592982537447-7440770cbfc9?auto=format&fit=crop&q=80&w=1200"
                        class="hero-slide">
                    <img src="https://images.unsplash.com/photo-1464226184884-fa280b87c399?auto=format&fit=crop&q=80&w=1200"
                        class="hero-slide">
                    <img src="https://images.unsplash.com/photo-1560493676-04071c5f467b?auto=format&fit=crop&q=80&w=1200"
                        class="hero-slide">
                    <img src="https://images.unsplash.com/photo-1586771107445-d3ca888129ff?auto=format&fit=crop&q=80&w=1200"
                        class="hero-slide">

                    <img src="https://images.unsplash.com/photo-1500651230702-0e2d8a49d4ad?auto=format&fit=crop&q=80&w=1200"
                        class="hero-slide">
                    <img src="https://images.unsplash.com/photo-1471193945509-9ad0617afabf?auto=format&fit=crop&q=80&w=1200"
                        class="hero-slide">
                    <img src="https://images.unsplash.com/photo-1500937386664-56d1dfef3854?auto=format&fit=crop&q=80&w=1200"
                        class="hero-slide">

                    <img src="https://images.unsplash.com/photo-1515023115689-589c33041d3c?auto=format&fit=crop&q=80&w=1200"
                        class="hero-slide">
                    <img src="https://images.unsplash.com/photo-1530507629858-e4977d30e9e0?auto=format&fit=crop&q=80&w=1200"
                        class="hero-slide">
                    <img src="https://images.unsplash.com/photo-1516253593875-bd7ba052fbc5?auto=format&fit=crop&q=80&w=1200"
                        class="hero-slide">
                </div>
                <div class="hero-overlay">
                </div>
            </div>

            <!-- WEATHER MONITORING SECTION -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-12">
                <div class="card p-6 flex items-center gap-6">
                    <div
                        class="w-12 h-12 bg-amber-100 dark:bg-amber-900/30 text-amber-600 rounded-2xl flex items-center justify-center text-xl">
                        <i class="fas fa-temperature-high"></i>
                    </div>
                    <div>
                        <h4 class="text-2xl font-black mb-1" id="dash-wTemp">--¬∞C</h4>
                        <p class="text-xs font-bold uppercase opacity-50">Local Temperature</p>
                    </div>
                </div>
                <div class="card p-6 flex items-center gap-6 bg-blue-50/10 border-blue-600/20">
                    <div
                        class="w-12 h-12 bg-blue-100 dark:bg-blue-900/30 text-blue-600 rounded-2xl flex items-center justify-center text-xl">
                        <i class="fas fa-droplet"></i>
                    </div>
                    <div>
                        <h4 class="text-2xl font-black mb-1" id="dash-wHum">--%</h4>
                        <p class="text-xs font-bold uppercase opacity-50">Air Humidity</p>
                    </div>
                </div>
                <div class="card p-6 flex items-center gap-6">
                    <div
                        class="w-12 h-12 bg-slate-100 dark:bg-slate-900/30 text-slate-600 rounded-2xl flex items-center justify-center text-xl">
                        <i class="fas fa-wind"></i>
                    </div>
                    <div>
                        <h4 class="text-2xl font-black mb-1" id="dash-wWind">-- km/h</h4>
                        <p class="text-xs font-bold uppercase opacity-50">Wind Speed</p>
                    </div>
                </div>
            </div>

            <!-- ADVISORY & WARNINGS -->
            <div class="card p-8 bg-white dark:bg-slate-950 border-none shadow-xl mb-12 overflow-hidden relative">
                <div class="flex flex-col lg:flex-row gap-10 relative z-10">
                    <div class="lg:w-1/3">
                        <h4
                            class="text-sm font-black uppercase tracking-widest flex items-center gap-2 mb-6 text-red-600">
                            <i class="fas fa-tower-broadcast animate-pulse"></i> Early Warning System
                        </h4>
                        <div class="space-y-4">
                            <div class="p-4 rounded-2xl bg-red-600/10 border border-red-600/20">
                                <p class="text-[10px] font-black uppercase text-red-600 mb-1">Pest Outbreak Alert</p>
                                <p class="text-xs font-bold">Fall Armyworm detected in nearby 15km zone.</p>
                            </div>
                            <div class="p-4 rounded-2xl bg-amber-600/10 border border-amber-600/20">
                                <p class="text-[10px] font-black uppercase text-amber-600 mb-1">Weather Advisory</p>
                                <p class="text-xs font-bold">Unexpected light rain expected in 48 hours. Postpone
                                    harvesting.</p>
                            </div>
                        </div>
                    </div>
                    <div class="lg:w-2/3 border-l border-slate-100 dark:border-white/5 lg:pl-10">
                        <h4
                            class="text-sm font-black uppercase tracking-widest flex items-center gap-2 mb-6 text-blue-600">
                            <i class="fas fa-calendar-days"></i> Irrigation & Harvest Scheduling
                        </h4>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <div class="p-4 rounded-2xl bg-slate-50 dark:bg-slate-900 text-center">
                                <p class="text-[9px] font-black uppercase opacity-40 mb-1">Next Watering</p>
                                <p class="text-xs font-black">Tomorrow</p>
                                <p class="text-[8px] font-bold opacity-40">06:00 AM</p>
                            </div>
                            <div class="p-4 rounded-2xl bg-slate-50 dark:bg-slate-900 text-center">
                                <p class="text-[9px] font-black uppercase opacity-40 mb-1">Fertilizer Cycle</p>
                                <p class="text-xs font-black">Day 42</p>
                                <p class="text-[8px] font-bold opacity-40">NPK Balanced</p>
                            </div>
                            <div class="p-4 rounded-2xl bg-slate-50 dark:bg-slate-900 text-center">
                                <p class="text-[9px] font-black uppercase opacity-40 mb-1">Est. Harvest</p>
                                <p class="text-xs font-black">22 Days</p>
                                <p class="text-[8px] font-bold opacity-40">Phase 4 Ready</p>
                            </div>
                            <div
                                class="p-4 rounded-2xl bg-slate-50 dark:bg-slate-900 text-center border-l-4 border-green-500">
                                <p class="text-[9px] font-black uppercase opacity-40 mb-1">Market Window</p>
                                <p class="text-xs font-black text-green-500">OPTIMAL</p>
                                <p class="text-[8px] font-bold opacity-40">High Demand</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ENHANCED ANALYTICS WIDGETS -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-12">
                <div class="card p-6 bg-white dark:bg-slate-950 border-none shadow-lg">
                    <div class="flex items-center gap-4 mb-4">
                        <div
                            class="w-10 h-10 rounded-xl bg-green-100 dark:bg-green-900/30 text-green-600 flex items-center justify-center shadow-sm">
                            <i class="fas fa-vial"></i>
                        </div>
                        <h5 class="font-black text-xs uppercase tracking-widest opacity-60">Soil Health</h5>
                    </div>
                    <div class="flex items-end justify-between">
                        <div>
                            <p class="text-2xl font-black" id="dash-soil-ph">6.8 pH</p>
                            <p class="text-[10px] font-bold text-green-500 uppercase">Optimal Range</p>
                        </div>
                        <div class="w-16 h-8 bg-green-500/10 rounded-lg flex items-center justify-center">
                            <i class="fas fa-arrow-trend-up text-green-500 text-xs"></i>
                        </div>
                    </div>
                </div>

                <div class="card p-6 bg-white dark:bg-slate-950 border-none shadow-lg">
                    <div class="flex items-center gap-4 mb-4">
                        <div
                            class="w-10 h-10 rounded-xl bg-blue-100 dark:bg-blue-900/30 text-blue-600 flex items-center justify-center shadow-sm">
                            <i class="fas fa-sack-dollar"></i>
                        </div>
                        <h5 class="font-black text-xs uppercase tracking-widest opacity-60">Profit Snapshot</h5>
                    </div>
                    <div class="flex items-end justify-between">
                        <div>
                            <p class="text-2xl font-black" id="dash-profit">‚Çπ0</p>
                            <p class="text-[10px] font-bold text-blue-500 uppercase">Est. Revenue</p>
                        </div>
                        <div class="text-[10px] font-black opacity-30 uppercase text-right">
                            Hectare/Cycle
                        </div>
                    </div>
                </div>

                <div class="card p-6 bg-white dark:bg-slate-950 border-none shadow-lg">
                    <div class="flex items-center gap-4 mb-4">
                        <div
                            class="w-10 h-10 rounded-xl bg-purple-100 dark:bg-purple-900/30 text-purple-600 flex items-center justify-center shadow-sm">
                            <i class="fas fa-comments"></i>
                        </div>
                        <h5 class="font-black text-xs uppercase tracking-widest opacity-60">Expert Hub</h5>
                    </div>
                    <div class="flex items-end justify-between">
                        <div>
                            <p class="text-2xl font-black">Online</p>
                            <p class="text-[10px] font-bold text-purple-500 uppercase">3 Specialists active</p>
                        </div>
                        <button onclick="setView('expert')"
                            class="text-[10px] font-black text-purple-600 uppercase hover:underline">Chat Now</button>
                    </div>
                </div>

                <div class="card p-6 bg-white dark:bg-slate-950 border-none shadow-lg">
                    <div class="flex items-center gap-4 mb-4">
                        <div
                            class="w-10 h-10 rounded-xl bg-indigo-100 dark:bg-indigo-900/30 text-indigo-600 flex items-center justify-center shadow-sm">
                            <i class="fas fa-satellite-dish animate-pulse"></i>
                        </div>
                        <h5 class="font-black text-xs uppercase tracking-widest opacity-60">Agri-Radar</h5>
                    </div>
                    <div class="flex items-end justify-between">
                        <div>
                            <p class="text-2xl font-black">ACTIVE</p>
                            <p class="text-[10px] font-bold text-indigo-500 uppercase">Scanning 25km</p>
                        </div>
                        <button onclick="setView('radar')"
                            class="text-[10px] font-black text-indigo-600 uppercase hover:underline">Open Map</button>
                    </div>
                </div>
            </div>

            <!-- ACTION CARDS -->
            <div class="grid lg:grid-cols-2 gap-8">
                <div class="card p-10 group cursor-pointer border-2 hover:border-blue-600" onclick="setView('scan')">
                    <div
                        class="w-16 h-16 bg-blue-100 dark:bg-blue-900/40 text-blue-600 flex items-center justify-center rounded-2xl text-3xl mb-6 group-hover:scale-110 transition-all">
                        <i class="fas fa-camera"></i>
                    </div>
                    <h4 class="text-3xl font-black mb-3">Scan Crop Disease</h4>
                    <p class="opacity-60 mb-8 leading-relaxed">Run instant biological checks on your crops using
                        advanced HD image recognition engine.</p>
                    <button class="bg-blue-600 text-white font-bold py-3 px-8 rounded-xl">Open Scanner</button>
                </div>
                <div class="card p-10 group cursor-pointer border-2 hover:border-green-600" onclick="setView('yield')">
                    <div
                        class="w-16 h-16 bg-green-100 dark:bg-green-900/40 text-green-600 flex items-center justify-center rounded-2xl text-3xl mb-6 group-hover:scale-110 transition-all">
                        <i class="fas fa-chart-pie"></i>
                    </div>
                    <h4 class="text-3xl font-black mb-3">Yield Forecast</h4>
                    <p class="opacity-60 mb-8 leading-relaxed">Estimate seasonal revenue using soil pH, NPK levels, and
                        local rainfall parameters.</p>
                    <button class="bg-green-600 text-white font-bold py-3 px-8 rounded-xl">Open Forecast</button>
                </div>
            </div>
        </section>

        <!-- SCAN VIEW -->
        <section id="view-scan" class="hidden space-y-12">
            <div class="grid lg:grid-cols-2 gap-10">
                <div class="card p-10">
                    <div class="flex items-center justify-between mb-8">
                        <h3 class="text-2xl font-bold">Diagnostic Hub</h3>
                        <div class="flex bg-slate-100 dark:bg-slate-800 p-1 rounded-xl">
                            <button onclick="setScanMode('upload')" id="mode-upload"
                                class="scan-mode-btn px-4 py-2 rounded-lg text-xs font-black uppercase transition-all active">Upload</button>
                            <button onclick="setScanMode('camera')" id="mode-camera"
                                class="scan-mode-btn px-4 py-2 rounded-lg text-xs font-black uppercase transition-all">Camera</button>
                        </div>
                    </div>

                    <div class="space-y-6">
                        <select id="cropType"
                            class="bg-slate-50 dark:bg-slate-950 border-2 border-slate-100 dark:border-slate-800 h-14 rounded-2xl px-4 font-black text-sm outline-none focus:border-blue-600">
                            <option value="maize">Maize (Seedling)</option>
                            <option value="wheat">Wheat Crop</option>
                            <option value="tomato">Tomato Plant</option>
                        </select>

                        <!-- UPLOAD MODE -->
                        <div id="area-upload" class="scan-area">
                            <div class="border-2 border-dashed border-slate-300 dark:border-slate-700 rounded-3xl p-16 text-center cursor-pointer hover:bg-blue-50/50"
                                onclick="document.getElementById('img').click()">
                                <i class="fas fa-cloud-arrow-up text-5xl text-blue-600 mb-4"></i>
                                <h4 class="font-bold">Click to Upload Leaf</h4>
                                <input type="file" id="img" class="hidden" accept="image/*">
                            </div>
                        </div>

                        <!-- CAMERA MODE -->
                        <div id="area-camera" class="scan-area hidden">
                            <div class="relative rounded-3xl overflow-hidden bg-black aspect-video group">
                                <video id="video" autoplay playsinline class="w-full h-full object-cover"></video>
                                <div class="absolute inset-0 flex items-center justify-center pointer-events-none">
                                    <div
                                        class="w-48 h-48 border-2 border-dashed border-blue-500/50 rounded-full animate-pulse">
                                    </div>
                                </div>
                                <div class="absolute bottom-4 left-0 right-0 flex justify-center gap-4">
                                    <button onclick="switchCamera()"
                                        class="w-12 h-12 rounded-full bg-white/10 backdrop-blur-md border border-white/20 text-white flex items-center justify-center hover:bg-white/20 transition-all">
                                        <i class="fas fa-camera-rotate"></i>
                                    </button>
                                    <button onclick="capturePhoto()"
                                        class="w-12 h-12 rounded-full bg-blue-600 text-white flex items-center justify-center shadow-lg shadow-blue-600/40 hover:scale-110 active:scale-95 transition-all">
                                        <i class="fas fa-camera"></i>
                                    </button>
                                </div>
                            </div>
                        </div>



                        <div id="prev" class="hidden rounded-3xl overflow-hidden shadow-xl relative group">
                            <img src="" id="tImg" class="w-full h-80 object-cover">
                            <button onclick="clearSelection()"
                                class="absolute top-4 right-4 w-10 h-10 rounded-full bg-black/50 backdrop-blur-md text-white flex items-center justify-center hover:bg-red-600 transition-all">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>

                        <button id="scanBtn"
                            class="w-full bg-blue-600 text-white h-16 rounded-2xl font-black text-xl disabled:opacity-50 shadow-xl shadow-blue-600/20 active:scale-95 transition-all">ANALYZE
                            NOW</button>

                        <button onclick="detectAndAnalyze()" id="autoBtn"
                            class="w-full bg-slate-100 dark:bg-slate-800 text-slate-500 h-12 rounded-2xl font-black text-[10px] uppercase tracking-widest hover:bg-slate-200 dark:hover:bg-slate-700 transition-all flex items-center justify-center gap-2">
                            <i class="fas fa-magic text-blue-500"></i> Smart AI: Auto-Detect Crop
                        </button>
                    </div>
                </div>

                <div class="card p-10 flex flex-col min-h-[500px]" id="res-page">

                    <div id="loading" class="hidden flex-1 flex flex-col items-center justify-center">
                        <div class="w-14 h-14 border-4 border-blue-600 border-t-transparent rounded-full animate-spin">
                        </div>
                    </div>
                    <div id="empty"
                        class="flex-1 flex flex-col items-center justify-center relative overflow-hidden rounded-3xl min-h-[300px]">
                        <img src="https://images.unsplash.com/photo-1582719471384-894fbb16e074?auto=format&fit=crop&q=80&w=1000"
                            class="absolute inset-0 w-full h-full object-cover opacity-20">
                        <div class="relative z-10 flex flex-col items-center">
                            <i class="fas fa-dna text-[80px] opacity-30 text-blue-500 mb-4 animate-pulse"></i>
                            <p class="font-bold uppercase tracking-[4px] opacity-40 text-xs">Awaiting Analysis Data</p>
                        </div>
                    </div>


                    <div id="results" class="hidden space-y-8">
                        <div id="stCard" class="p-10 rounded-[36px] bg-slate-50 dark:bg-slate-950 text-center">
                            <p class="text-[10px] font-bold opacity-30 uppercase tracking-[4px] mb-2">Diagnostic Result
                            </p>
                            <h2 class="text-5xl font-black uppercase" id="stText">Healthy</h2>
                        </div>
                        <div class="grid grid-cols-1 gap-6">
                            <div class="p-6 rounded-2xl border text-center font-bold">
                                <p class="text-xs opacity-40 mb-1">Confidence Score</p>
                                <p class="text-2xl text-blue-600" id="cfText">0%</p>
                            </div>
                        </div>
                        <div id="disBox" class="hidden p-8 rounded-[36px] bg-red-600 text-white">
                            <h4 class="text-2xl font-bold mb-2 flex items-center gap-3"><i class="fas fa-warning"></i>
                                <span id="disName">Pests</span>
                            </h4>
                            <p class="opacity-80 text-sm">Pathogen detected. Apply corrective treatment immediately.</p>
                        </div>

                        <!-- REMEDIES CARD -->
                        <div id="remedyCard"
                            class="hidden p-8 rounded-[36px] bg-white dark:bg-slate-900 border-2 border-blue-600/20 shadow-xl space-y-8">

                            <div>
                                <h4 class="text-xl font-black mb-4 flex items-center gap-3 text-blue-600">
                                    <i class="fas fa-kit-medical"></i> Action Plan / Remedies
                                </h4>
                                <ul id="remedyList" class="space-y-3 opacity-80 text-sm font-medium list-disc pl-5">
                                </ul>
                            </div>

                            <div class="pt-6 border-t border-slate-100 dark:border-slate-800">
                                <h4 class="text-xl font-black mb-4 flex items-center gap-3 text-amber-600">
                                    <i class="fas fa-shield-halved"></i> Essential Precautions
                                </h4>
                                <ul id="precautionList" class="space-y-3 opacity-80 text-sm font-medium list-disc pl-5">
                                </ul>
                            </div>

                            <button onclick="downloadPDFReport()"
                                class="w-full py-4 bg-slate-100 dark:bg-slate-800 hover:bg-slate-200 dark:hover:bg-slate-700 rounded-2xl font-black text-xs uppercase tracking-widest transition-all flex items-center justify-center gap-3">
                                <i class="fas fa-file-pdf text-red-600"></i> Download Full Report (PDF)
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- YIELD VIEW -->
        <section id="view-yield" class="hidden space-y-12">
            <!-- TOP STATS BAR -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <div class="card p-6 bg-green-500/10 border-green-500/20">
                    <p class="text-[10px] uppercase font-bold opacity-40 mb-1">Seasonal Status</p>
                    <h4 class="text-xl font-black text-green-600">Peak Sowing</h4>
                </div>
                <div class="card p-6">
                    <p class="text-[10px] uppercase font-bold opacity-40 mb-1">Mandi Price (Avg)</p>
                    <h4 class="text-xl font-black text-blue-600">‚Çπ 2,240 <span
                            class="text-xs opacity-40 font-bold">/qtl</span></h4>
                </div>
                <div class="card p-6">
                    <p class="text-[10px] uppercase font-bold opacity-40 mb-1">Subsidy Alerts</p>
                    <h4 class="text-xl font-black text-amber-600">2 Active</h4>
                </div>
                <div class="card p-6">
                    <p class="text-[10px] uppercase font-bold opacity-40 mb-1">Next Harvest</p>
                    <h4 class="text-xl font-black opacity-60">~ Oct 24</h4>
                </div>
            </div>

            <div class="grid lg:grid-cols-3 gap-10">
                <!-- INPUT COLUMN -->
                <div class="card p-8 lg:col-span-1 border-2 border-slate-100 dark:border-slate-800">
                    <div class="flex items-center gap-3 mb-8">
                        <i class="fas fa-sliders text-blue-600 text-xl"></i>
                        <h3 class="text-xl font-black uppercase tracking-tight">Farm Profile</h3>
                    </div>
                    <form id="yForm" class="space-y-6">
                        <div class="space-y-4">
                            <div>
                                <label
                                    class="text-[10px] uppercase font-bold opacity-40 mb-1 block flex justify-between">
                                    <span>Field Size (Acres)</span>
                                    <span class="text-blue-600 font-bold">[0.1 - 1000]</span>
                                </label>
                                <div class="relative">
                                    <i
                                        class="fas fa-expand-arrows-alt absolute left-4 top-1/2 -translate-y-1/2 opacity-30 text-xs"></i>
                                    <input type="number" name="area" value="10" min="0.1" max="1000" step="0.1" required
                                        class="pl-10">
                                </div>
                            </div>
                            <div>
                                <label class="text-[10px] uppercase font-bold opacity-40 mb-1 block">Soil
                                    Architecture</label>
                                <select name="soil_type" required>
                                    <option value="loam">Loam (Optimized)</option>
                                    <option value="clay">Clay (High Density)</option>
                                    <option value="sandy">Sandy (Low Retention)</option>
                                    <option value="silt">Silt (Fine Grain)</option>
                                </select>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-[10px] uppercase font-bold opacity-40 mb-1 block">pH Level</label>
                                <input type="number" step="0.1" name="soil_ph" value="6.8" min="3" max="10" required>
                            </div>
                            <div>
                                <label class="text-[10px] uppercase font-bold opacity-40 mb-1 block">Org. Matter
                                    %</label>
                                <input type="number" step="0.1" name="organic_matter" value="2.5" min="0.1" max="15"
                                    required>
                            </div>
                        </div>

                        <div
                            class="p-6 rounded-3xl bg-slate-50 dark:bg-slate-900 border border-slate-200 dark:border-slate-800">
                            <p class="text-[10px] uppercase font-bold opacity-40 mb-4 flex items-center gap-2">
                                <i class="fas fa-cloud-sun"></i> Environmental Forecast
                            </p>
                            <div class="space-y-4">
                                <input type="number" name="rainfall" placeholder="Rainfall (mm)" value="1000" min="0"
                                    max="4000" required>
                                <input type="number" name="temperature" placeholder="Temp (¬∞C)" value="30" min="5"
                                    max="50" required>
                                <input type="number" name="humidity" placeholder="Humidity (%)" value="65" min="1"
                                    max="100" required>
                            </div>
                        </div>

                        <div
                            class="p-6 rounded-3xl bg-blue-50/50 dark:bg-blue-900/10 border border-blue-200/50 dark:border-blue-800/50">
                            <p class="text-[10px] uppercase font-bold opacity-40 mb-4 flex items-center gap-2">
                                <i class="fas fa-flask"></i> Nutrient Management (NPK)
                            </p>
                            <div class="grid grid-cols-3 gap-2">
                                <input type="number" name="fertilizer_n" placeholder="N" value="120" min="0" max="300"
                                    required>
                                <input type="number" name="fertilizer_p" placeholder="P" value="60" min="0" max="300"
                                    required>
                                <input type="number" name="fertilizer_k" placeholder="K" value="60" min="0" max="300"
                                    required>
                            </div>
                        </div>

                        <div class="flex gap-4 p-4 rounded-2xl bg-slate-50 dark:bg-slate-900">
                            <label class="flex items-center gap-3 font-bold cursor-pointer group">
                                <input type="checkbox" name="crops" value="maize" checked
                                    class="w-5 h-5 accent-blue-600">
                                <span class="group-hover:text-blue-600 transition-colors">Maize</span>
                            </label>
                            <label class="flex items-center gap-3 font-bold cursor-pointer group">
                                <input type="checkbox" name="crops" value="wheat" checked
                                    class="w-5 h-5 accent-blue-600">
                                <span class="group-hover:text-blue-600 transition-colors">Wheat</span>
                            </label>
                            <label class="flex items-center gap-3 font-bold cursor-pointer group">
                                <input type="checkbox" name="crops" value="tomato" class="w-5 h-5 accent-blue-600">
                                <span class="group-hover:text-blue-600 transition-colors">Tomato</span>
                            </label>
                        </div>

                        <button type="submit"
                            class="w-full bg-blue-600 hover:bg-blue-700 text-white h-16 rounded-3xl font-black text-xl transition-all active:scale-95 shadow-xl shadow-blue-600/30 flex items-center justify-center gap-3">
                            <i class="fas fa-radar"></i> RUN FORECAST
                        </button>
                    </form>
                </div>

                <!-- OUTPUT COLUMN -->
                <div class="lg:col-span-2 space-y-8 flex flex-col">
                    <!-- MAIN DISPLAY -->
                    <div id="yResPage"
                        class="card p-10 bg-slate-950 border-none text-white relative overflow-hidden group shadow-2xl min-h-[400px] flex-1">
                        <div
                            class="absolute inset-0 opacity-20 pointer-events-none group-hover:opacity-30 transition-opacity">
                            <img src="https://images.unsplash.com/photo-1500382017468-9049fed747ef?auto=format&fit=crop&q=80&w=1500"
                                class="w-full h-full object-cover">
                        </div>
                        <div class="flex flex-col h-full relative z-10">
                            <div class="flex justify-between items-start mb-12">
                                <div>
                                    <p class="text-xs font-bold opacity-40 uppercase tracking-[6px] mb-2">Portfolio
                                        Valuation</p>
                                    <h2 class="text-7xl font-black text-blue-500" id="yVal">‚Çπ 0</h2>
                                    <button onclick="showCalculation()"
                                        class="text-[9px] font-black uppercase text-blue-500 hover:text-blue-600 transition-colors flex items-center gap-2 mt-4 group">
                                        <div
                                            class="w-6 h-6 rounded-lg bg-blue-500/10 flex items-center justify-center group-hover:scale-110 transition-all">
                                            <i class="fas fa-fingerprint"></i>
                                        </div>
                                        <span>Verify Calculation Integrity</span>
                                    </button>
                                </div>
                                <div id="ySummary" class="hidden text-right">
                                    <div
                                        class="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-white/5 border border-white/10 mb-4">
                                        <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                                        <p class="text-[10px] font-bold uppercase tracking-widest opacity-60">Engine
                                            Ready</p>
                                    </div>
                                    <div id="yRiskBadge"
                                        class="p-3 rounded-2xl bg-white/5 border border-white/10 text-center min-w-[120px]">
                                        <p class="text-[9px] uppercase opacity-40 mb-1">Risk Assessment</p>
                                        <p class="text-sm font-black" id="yRisk">LOW</p>
                                    </div>
                                </div>
                            </div>

                            <div id="yRows" class="grid md:grid-cols-2 gap-4 flex-1">
                                <!-- JS Injects Crop Cards -->
                                <div
                                    class="col-span-full flex flex-col items-center justify-center opacity-20 py-10 border-2 border-dashed border-white/10 rounded-3xl">
                                    <i class="fas fa-microchip text-4xl mb-4"></i>
                                    <p class="font-bold uppercase tracking-widest text-xs">Awaiting Input Data</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ANALYTICS GRID -->
                    <div id="yAnalytics" class="hidden grid md:grid-cols-2 gap-8">
                        <!-- FINANCIAL METRICS -->
                        <div class="card p-8 bg-white dark:bg-slate-900 border-none shadow-xl">
                            <h4 class="text-sm font-black uppercase tracking-widest mb-6 flex items-center gap-2">
                                <i class="fas fa-chart-line text-blue-600"></i> Financial Resilience
                            </h4>
                            <div class="space-y-6">
                                <div id="finStats" class="grid grid-cols-2 gap-4">
                                    <div class="p-4 rounded-2xl bg-slate-50 dark:bg-slate-800/50 border text-center">
                                        <p class="text-[9px] font-bold opacity-40 mb-1">TOTAL PROFIT</p>
                                        <p class="text-xl font-black text-green-500" id="yProfit">‚Çπ 0</p>
                                    </div>
                                    <div class="p-4 rounded-2xl bg-slate-50 dark:bg-slate-800/50 border text-center">
                                        <p class="text-[9px] font-bold opacity-40 mb-1">SUITABILITY</p>
                                        <p class="text-xl font-black text-blue-500" id="yScore">0%</p>
                                    </div>
                                </div>
                                <!-- PROFIT BAR CHART -->
                                <div class="h-40 w-full bg-slate-50 dark:bg-slate-950/30 rounded-2xl p-4">
                                    <canvas id="yieldChart"></canvas>
                                </div>
                            </div>
                        </div>

                        <!-- OPTIMIZATION INSIGHTS -->
                        <div class="card p-8 shadow-xl relative overflow-hidden border-none bg-white dark:bg-slate-900">
                            <div class="flex items-center justify-between mb-8">
                                <h4 class="text-sm font-black uppercase tracking-widest flex items-center gap-2">
                                    <i class="fas fa-lightbulb text-amber-500"></i> Precision Insights
                                </h4>
                                <button class="p-2 hover:bg-slate-100 rounded-xl transition-colors"><i
                                        class="fas fa-share-nodes text-xs opacity-40"></i></button>
                            </div>
                            <ul id="insightList" class="space-y-4">
                                <!-- JS Injects Insights -->
                            </ul>
                            <div class="mt-8 pt-6 border-t font-bold text-xs opacity-40 italic flex items-center gap-2">
                                <i class="fas fa-shield-check text-green-500"></i> Analysis verified by AgriQuest Engine
                            </div>
                        </div>
                    </div>

                    <!-- CHARTING PANEL ( Indian Market Trends ) -->
                    <div id="yChartPanel" class="hidden card p-8 bg-white dark:bg-slate-900 border-none shadow-xl">
                        <div class="flex justify-between items-center mb-8">
                            <h4 class="text-sm font-black uppercase tracking-widest flex items-center gap-2">
                                <i class="fas fa-indian-rupee-sign text-blue-600"></i> Market Price History (Mandi)
                            </h4>
                            <div class="flex gap-2">
                                <div
                                    class="flex items-center gap-1.5 px-3 py-1 rounded-lg bg-slate-100 dark:bg-slate-800 text-[9px] font-bold tracking-widest">
                                    12 MONTH TREND</div>
                            </div>
                        </div>
                        <div class="h-64 w-full">
                            <canvas id="marketChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- HISTORY VIEW -->
        <section id="view-history" class="hidden">
            <div class="card p-10">
                <div class="flex justify-between items-center mb-8">
                    <div>
                        <h3 class="text-2xl font-bold">Activity Logs</h3>
                        <p class="opacity-60 text-sm">Review your past crop scans and financial predictions</p>
                    </div>
                    <button onclick="loadHistory()"
                        class="p-3 rounded-2xl bg-slate-100 dark:bg-slate-800 hover:bg-blue-600 hover:text-white transition-all">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>

                <div id="historyList" class="space-y-4">
                    <!-- JS will inject history items -->
                    <div
                        class="border-2 border-dashed border-slate-200 dark:border-slate-800 rounded-3xl p-20 text-center">
                        <i class="fas fa-folder-open text-4xl opacity-20 mb-4"></i>
                        <p class="font-bold opacity-30">Loading your history...</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- MARKETS VIEW -->
        <section id="view-markets" class="hidden space-y-8">
            <!-- MARKET HEADER -->
            <div
                class="card p-10 bg-gradient-to-br from-slate-900 to-blue-900 text-white border-none shadow-2xl relative overflow-hidden">
                <div class="absolute right-0 top-0 w-2/3 h-full opacity-30 pointer-events-none">
                    <img src="https://images.unsplash.com/photo-1488459736882-d7921b7ceaf0?auto=format&fit=crop&q=80&w=1500"
                        class="w-full h-full object-cover mask-gradient-left">
                </div>
                <div class="relative z-10">
                    <h3 class="text-4xl font-black mb-2 tracking-tight">Market Pulse</h3>
                    <p class="opacity-60 font-black uppercase tracking-[5px] text-[10px]">Real-time Mandi Insights &
                        Price Forecasting</p>
                </div>
            </div>
            <div class="space-y-8">
                <!-- LIVE PRICE PULSE -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="card p-6 border-l-4 border-amber-500">
                        <div class="flex justify-between items-start mb-4">
                            <div
                                class="w-10 h-10 rounded-xl bg-amber-100 dark:bg-amber-900/30 text-amber-600 flex items-center justify-center">
                                <i class="fas fa-seedling"></i>
                            </div>
                            <span
                                class="text-[9px] font-black text-amber-500 bg-amber-500/10 px-2 py-1 rounded-md uppercase">Maize</span>
                        </div>
                        <h4 class="text-xs font-bold opacity-40 uppercase tracking-widest mb-1">Current Mandi Price</h4>
                        <div class="flex items-baseline gap-2">
                            <span class="text-3xl font-black">‚Çπ 2,150</span>
                            <span class="text-xs font-bold text-green-500"><i class="fas fa-caret-up"></i> 4.2%</span>
                        </div>
                        <div class="mt-4 pt-4 border-t border-slate-100 dark:border-white/5 grid grid-cols-2 gap-2">
                            <div>
                                <p class="text-[9px] font-bold opacity-40 uppercase">Today's MSP</p>
                                <p class="text-xs font-black">‚Çπ 2,090</p>
                            </div>
                            <div>
                                <p class="text-[9px] font-bold opacity-40 uppercase">Market Vol.</p>
                                <p class="text-xs font-black">1.2K Tons</p>
                            </div>
                        </div>
                    </div>

                    <div class="card p-6 border-l-4 border-red-500">
                        <div class="flex justify-between items-start mb-4">
                            <div
                                class="w-10 h-10 rounded-xl bg-red-100 dark:bg-red-900/30 text-red-600 flex items-center justify-center">
                                <i class="fas fa-apple-whole"></i>
                            </div>
                            <span
                                class="text-[9px] font-black text-red-500 bg-red-500/10 px-2 py-1 rounded-md uppercase">Tomato</span>
                        </div>
                        <h4 class="text-xs font-bold opacity-40 uppercase tracking-widest mb-1">Current Mandi Price</h4>
                        <div class="flex items-baseline gap-2">
                            <span class="text-3xl font-black">‚Çπ 1,820</span>
                            <span class="text-xs font-bold text-red-500"><i class="fas fa-caret-down"></i> 2.1%</span>
                        </div>
                        <div class="mt-4 pt-4 border-t border-slate-100 dark:border-white/5 grid grid-cols-2 gap-2">
                            <div>
                                <p class="text-[9px] font-bold opacity-40 uppercase">Avg. Price</p>
                                <p class="text-xs font-black">‚Çπ 1,750</p>
                            </div>
                            <div>
                                <p class="text-[9px] font-bold opacity-40 uppercase">Daily Supply</p>
                                <p class="text-xs font-black">840 Tons</p>
                            </div>
                        </div>
                    </div>

                    <div class="card p-6 border-l-4 border-green-500">
                        <div class="flex justify-between items-start mb-4">
                            <div
                                class="w-10 h-10 rounded-xl bg-green-100 dark:bg-green-900/30 text-green-600 flex items-center justify-center">
                                <i class="fas fa-wheat-awn"></i>
                            </div>
                            <span
                                class="text-[9px] font-black text-green-500 bg-green-500/10 px-2 py-1 rounded-md uppercase">Wheat</span>
                        </div>
                        <h4 class="text-xs font-bold opacity-40 uppercase tracking-widest mb-1">Current Mandi Price</h4>
                        <div class="flex items-baseline gap-2">
                            <span class="text-3xl font-black mandi-price-main">‚Çπ 2,340</span>
                            <span class="text-xs font-bold text-green-500"><i class="fas fa-caret-up"></i> 1.8%</span>
                        </div>
                        <div class="mt-4 pt-4 border-t border-slate-100 dark:border-white/5 grid grid-cols-2 gap-2">
                            <div>
                                <p class="text-[9px] font-bold opacity-40 uppercase">Govt. MSP</p>
                                <p class="text-xs font-black">‚Çπ 2,275</p>
                            </div>
                            <div>
                                <p class="text-[9px] font-bold opacity-40 uppercase">Trade Vol.</p>
                                <p class="text-xs font-black">2.1K Tons</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="grid lg:grid-cols-3 gap-8">
                    <!-- MARKET INTELLIGENCE HUB -->
                    <div class="lg:col-span-2 space-y-8">
                        <!-- NEARBY MANDI LOCATOR -->
                        <div class="card p-8">
                            <div class="flex justify-between items-center mb-8">
                                <h4 id="marketHubTitle"
                                    class="text-sm font-black uppercase tracking-widest flex items-center gap-2">
                                    <i class="fas fa-map-location-dot text-blue-600"></i> Mandi Logistics Hub
                                </h4>
                                <button onclick="openMandiMap()"
                                    class="text-[10px] font-black text-blue-600 bg-blue-600/10 px-3 py-1.5 rounded-lg uppercase hover:bg-blue-600 hover:text-white transition-all">View
                                    Map</button>
                            </div>
                            <div class="space-y-4">
                                <div
                                    class="flex items-center justify-between p-5 rounded-2xl bg-slate-50 dark:bg-slate-800/50 border border-transparent hover:border-blue-500/20 transition-all">
                                    <div class="flex items-center gap-4">
                                        <div
                                            class="w-12 h-12 rounded-xl bg-white dark:bg-slate-900 flex items-center justify-center text-xl shadow-sm">
                                            üè¢</div>
                                        <div>
                                            <p class="font-black mandi-name">Thanjavur APMC Mandi</p>
                                            <p class="text-[10px] font-bold opacity-40 uppercase">Open: 08:00 AM - 04:00
                                                PM</p>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-sm font-black text-blue-600 mandi-dist">12 KM</p>
                                        <p class="text-[9px] font-bold opacity-40 uppercase underline">Est. Transport: ‚Çπ
                                            1,450</p>
                                    </div>
                                </div>
                                <div
                                    class="flex items-center justify-between p-5 rounded-2xl bg-slate-50 dark:bg-slate-800/50 border border-transparent hover:border-blue-500/20 transition-all">
                                    <div class="flex items-center gap-4">
                                        <div
                                            class="w-12 h-12 rounded-xl bg-white dark:bg-slate-900 flex items-center justify-center text-xl shadow-sm">
                                            üè¢</div>
                                        <div>
                                            <p class="font-black mandi-name">Coimbatore Central Hub</p>
                                            <p class="text-[10px] font-bold opacity-40 uppercase">Open: 06:00 AM - 02:00
                                                PM</p>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-sm font-black text-blue-600 mandi-dist">45 KM</p>
                                        <p class="text-[9px] font-bold opacity-40 uppercase underline">Est. Transport: ‚Çπ
                                            3,200</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- PRICE ANALYTICS HUB -->
                        <div class="card p-8 bg-white dark:bg-slate-900 border-none shadow-xl">
                            <div class="flex justify-between items-center mb-8">
                                <h4 class="text-sm font-black uppercase tracking-widest flex items-center gap-2">
                                    <i class="fas fa-chart-line text-blue-600"></i> Price Analytics Hub
                                </h4>
                                <div class="flex gap-2" id="marketToggles">
                                    <button onclick="updateMarketChart('7d')" id="btn-7d"
                                        class="px-3 py-1 rounded-lg bg-blue-600 text-white text-[9px] font-black uppercase transition-all">7
                                        Days</button>
                                    <button onclick="updateMarketChart('30d')" id="btn-30d"
                                        class="px-3 py-1 rounded-lg bg-slate-100 dark:bg-slate-800 text-[9px] font-black uppercase transition-all">Monthly</button>
                                </div>
                            </div>
                            <div class="h-64 w-full">
                                <canvas id="marketDetailChart"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- STRATEGIC FARMER INSIGHTS -->
                    <div class="space-y-6">
                        <div
                            class="card p-8 bg-gradient-to-br from-blue-600 to-indigo-700 text-white border-none shadow-2xl">
                            <div class="flex items-center gap-3 mb-6">
                                <div class="w-10 h-10 rounded-xl bg-white/20 flex items-center justify-center text-xl">
                                    <i class="fas fa-brain"></i>
                                </div>
                                <h4 class="text-sm font-black uppercase tracking-widest">Market IQ</h4>
                            </div>
                            <div class="p-4 rounded-2xl bg-white/10 mb-6">
                                <p class="text-[10px] font-bold opacity-60 uppercase mb-2">Selling Recommendation</p>
                                <div class="flex justify-between items-center">
                                    <span class="text-lg font-black uppercase">HOLD STOCK</span>
                                    <span class="px-2 py-1 rounded-md bg-amber-500 text-[9px] font-black">WAIT 4
                                        DAYS</span>
                                </div>
                                <p class="text-[9px] mt-2 opacity-60 leading-relaxed">Festival of Makar Sankranti
                                    approaching. Prices expected to rise by 12%.</p>
                            </div>
                            <div class="space-y-4">
                                <div class="flex justify-between items-center text-xs">
                                    <span class="font-bold opacity-60">Quality Grade Req.</span>
                                    <span class="font-black">GRADE A / B</span>
                                </div>
                                <div class="flex justify-between items-center text-xs">
                                    <span class="font-bold opacity-60">Storage Cost/M</span>
                                    <span class="font-black">‚Çπ 140 / quintal</span>
                                </div>
                            </div>
                        </div>

                        <!-- PROFIT CALCULATOR -->
                        <div class="card p-6 bg-slate-900 border-none shadow-xl">
                            <h4 class="text-[10px] font-black text-white uppercase tracking-[3px] mb-6">Margin
                                Calculator</h4>
                            <div class="space-y-4">
                                <div class="space-y-2">
                                    <label class="text-[9px] font-black text-white/40 uppercase">Enter Selling Price
                                        (‚Çπ)</label>
                                    <input type="number" id="mPrice" value="2150" oninput="calculateMargin()"
                                        class="h-10 text-xs bg-white/5 border-white/10 text-white">
                                </div>
                                <div class="space-y-2">
                                    <label class="text-[9px] font-black text-white/40 uppercase">Transport Cost
                                        (‚Çπ)</label>
                                    <input type="number" id="mTransport" value="1450" oninput="calculateMargin()"
                                        class="h-10 text-xs bg-white/5 border-white/10 text-white">
                                </div>
                                <div class="pt-4 border-t border-white/10">
                                    <div class="flex justify-between items-center mb-1">
                                        <span class="text-[10px] font-black text-white opacity-40 uppercase">Net
                                            Margin/Acre</span>
                                        <span id="mResult" class="text-sm font-black text-green-500 uppercase">‚Çπ
                                            18,450</span>
                                    </div>
                                    <div class="w-full h-1 bg-white/5 rounded-full overflow-hidden">
                                        <div id="mBar" class="w-[65%] h-full bg-green-500 transition-all duration-500">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- AGRI-RADAR VIEW -->
        <section id="view-radar" class="hidden space-y-8">
            <div
                class="card p-8 bg-gradient-to-br from-indigo-900 to-slate-900 text-white border-none shadow-xl relative overflow-hidden">
                <div class="absolute right-0 top-0 w-1/3 h-full opacity-10 pointer-events-none">
                    <i class="fas fa-satellite-dish text-[180px] -rotate-12 translate-x-10"></i>
                </div>
                <div class="relative z-10">
                    <div class="flex items-center gap-4 mb-2">
                        <span
                            class="px-3 py-1 bg-blue-500 rounded-full text-[8px] font-black uppercase tracking-widest animate-pulse">Live
                            Radar</span>
                        <span class="text-[10px] font-bold opacity-60 uppercase tracking-[4px]">Geographic Pulse
                            Center</span>
                    </div>
                    <h3 class="text-3xl font-black uppercase tracking-tight">System Intel: Agri-Radar</h3>
                </div>
            </div>

            <div class="grid lg:grid-cols-3 gap-8">
                <!-- RADAR CORE -->
                <div class="lg:col-span-2 flex flex-col gap-6">
                    <div class="radar-container shadow-2xl">
                        <div class="radar-grid"></div>
                        <div class="radar-map" id="radarMap"></div>
                        <div class="radar-sweep"></div>

                        <!-- Dynamic Points Container -->
                        <div id="radarPoints"></div>
                    </div>

                    <!-- CONTROLS -->
                    <div
                        class="card p-6 bg-white dark:bg-slate-900 border-none shadow-xl flex justify-between items-center">
                        <div class="flex gap-4">
                            <button onclick="filterRadar('all')"
                                class="px-4 py-2 rounded-xl bg-blue-600 text-white text-[10px] font-black uppercase">All
                                Threats</button>
                            <button onclick="filterRadar('maize')"
                                class="px-4 py-2 rounded-xl bg-slate-100 dark:bg-slate-800 text-[10px] font-black uppercase">Maize</button>
                            <button onclick="filterRadar('tomato')"
                                class="px-4 py-2 rounded-xl bg-slate-100 dark:bg-slate-800 text-[10px] font-black uppercase">Tomato</button>
                        </div>
                        <div class="text-right">
                            <p class="text-[10px] font-black opacity-40 uppercase mb-1">Scanning Range</p>
                            <p class="text-sm font-black">25.0 KM Radius</p>
                        </div>
                    </div>
                </div>

                <!-- LIVE FEED -->
                <div class="flex flex-col gap-6">
                    <div class="card p-8 flex-1 bg-white dark:bg-slate-900 border-none shadow-xl flex flex-col">
                        <div class="flex justify-between items-center mb-6">
                            <h4 class="text-xs font-black uppercase tracking-widest">Public Pulse</h4>
                            <span class="w-2 h-2 rounded-full bg-green-500 animate-ping"></span>
                        </div>

                        <div id="radarFeed" class="space-y-4 overflow-y-auto max-h-[500px] pr-2 custom-scrollbar">
                            <!-- Feed items will be injected here -->
                            <div
                                class="p-4 rounded-2xl bg-slate-50 dark:bg-slate-800/50 border border-transparent animate-pulse">
                                <div class="w-2/3 h-2 bg-slate-200 dark:bg-slate-700 rounded mb-2"></div>
                                <div class="w-1/2 h-2 bg-slate-100 dark:bg-slate-800 rounded"></div>
                            </div>
                        </div>

                        <button
                            class="w-full mt-6 py-4 border border-blue-500/20 rounded-2xl text-[10px] font-black uppercase text-blue-500 hover:bg-blue-600 hover:text-white transition-all">
                            View Global Heatmap
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- EXPERT VIEW -->
        <section id="view-expert" class="hidden space-y-8">
            <!-- HEADER -->
            <div
                class="card p-8 bg-gradient-to-r from-blue-600 to-indigo-700 text-white border-none shadow-xl relative overflow-hidden">
                <div class="absolute right-0 top-0 w-1/2 h-full opacity-30 pointer-events-none">
                    <img src="https://images.unsplash.com/photo-1595273670150-db0a3d395754?auto=format&fit=crop&q=80&w=2000"
                        class="w-full h-full object-cover mask-gradient-left">
                </div>
                <div class="flex flex-col md:flex-row justify-between items-center gap-6 relative z-10">
                    <div>
                        <h3 class="text-3xl font-black uppercase tracking-tight mb-2">Expert Hub</h3>
                        <p class="opacity-80 font-bold uppercase text-[11px] tracking-[4px]">Direct Access to
                            Agricultural Intelligence</p>
                    </div>
                    <div class="flex gap-4">
                        <div onclick="document.getElementById('chatInput').focus()"
                            class="text-center px-4 py-2 bg-white/10 rounded-2xl border border-white/10 cursor-pointer hover:bg-white/20 transition-all">
                            <p class="text-xs font-black">24/7</p>
                            <p class="text-[8px] uppercase opacity-60">AI Doctor</p>
                        </div>
                        <div onclick="showLocationModal()"
                            class="text-center px-4 py-2 bg-white/10 rounded-2xl border border-white/10 cursor-pointer hover:bg-white/20 transition-all">
                            <p class="text-xs font-black">50+</p>
                            <p class="text-[8px] uppercase opacity-60">Consultants</p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid lg:grid-cols-3 gap-8 items-stretch">
                <!-- AI CROP DOCTOR CHATBOT -->
                <div class="lg:col-span-2 flex flex-col">
                    <div class="card p-8 flex-1 flex flex-col bg-white dark:bg-slate-900 border-none shadow-xl"
                        style="min-height: 75vh;">
                        <div
                            class="flex items-center justify-between mb-8 pb-4 border-b border-slate-100 dark:border-white/5">
                            <div class="flex items-center gap-4">
                                <div
                                    class="w-12 h-12 rounded-2xl bg-blue-600 text-white flex items-center justify-center text-xl shadow-lg shadow-blue-600/20">
                                    <i class="fas fa-robot"></i>
                                </div>
                                <div>
                                    <h4 class="font-black uppercase tracking-widest text-sm">AI Crop Doctor</h4>
                                    <span class="text-[10px] text-green-500 font-bold flex items-center gap-1">
                                        <span class="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></span> Online
                                        & Ready
                                    </span>
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="alert('Initiating Secure Voicemail to Expert...')"
                                    class="w-10 h-10 flex items-center justify-center hover:bg-slate-100 dark:hover:bg-slate-800 rounded-xl transition-all"><i
                                        class="fas fa-phone text-xs opacity-40"></i></button>
                                <button onclick="alert('Starting AI Face-to-Face Simulation...')"
                                    class="w-10 h-10 flex items-center justify-center hover:bg-slate-100 dark:hover:bg-slate-800 rounded-xl transition-all"><i
                                        class="fas fa-video text-xs opacity-40"></i></button>
                            </div>
                        </div>

                        <!-- CHAT AREA -->
                        <div id="chatMessages" class="flex-1 space-y-6 overflow-y-auto mb-6 pr-2 custom-scrollbar">
                            <div class="flex gap-4">
                                <div
                                    class="w-10 h-10 rounded-full bg-blue-100 dark:bg-blue-900/30 text-blue-600 flex items-center justify-center text-sm flex-shrink-0">
                                    <i class="fas fa-robot"></i>
                                </div>
                                <div
                                    class="bg-slate-50 dark:bg-slate-800/50 p-5 rounded-3xl rounded-tl-none max-w-[85%] border border-slate-100 dark:border-white/5">
                                    <p class="text-sm font-medium leading-relaxed">Namaste! I am your AI Crop Doctor.
                                        How can I protect your farm today? I can help with disease symptoms, pesticide
                                        choices, or fertilization plans.</p>
                                </div>
                            </div>
                        </div>

                        <!-- CHAT INPUT -->
                        <div class="relative pt-4 border-t border-slate-100 dark:border-white/5">
                            <input type="text" id="chatInput" placeholder="Explain your crop problem..."
                                class="w-full h-16 pl-6 pr-44 rounded-2xl border-2 border-slate-100 dark:border-slate-800 bg-transparent focus:border-blue-600 transition-all outline-none font-bold text-sm"
                                onkeypress="if(event.key === 'Enter') sendChatMessage()">
                            <div class="absolute right-3 top-1/2 -translate-y-1/2 flex items-center gap-3">
                                <button
                                    class="w-12 h-12 rounded-xl text-slate-400 hover:text-blue-600 hover:bg-blue-50 dark:hover:bg-blue-900/20 transition-all">
                                    <i class="fas fa-camera"></i>
                                </button>
                                <button onclick="sendChatMessage()" id="chatSendBtn"
                                    class="h-12 px-6 bg-blue-600 text-white rounded-xl font-black text-xs uppercase tracking-widest active:scale-95 transition-all shadow-lg shadow-blue-600/20">Send</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SIDEBAR TOOLS (Experts List) -->
                <div class="lg:col-span-1 flex flex-col">
                    <div class="card p-8 flex-1 flex flex-col bg-white dark:bg-slate-900 border-none shadow-xl">
                        <h4 class="font-black uppercase tracking-widest text-sm mb-6 flex items-center gap-3">
                            <i class="fas fa-user-doctor text-blue-600"></i> Nearby Specialists
                        </h4>
                        <div id="expertList" class="space-y-5 flex-1 overflow-y-auto">
                            <!-- JS will inject doctors here -->
                            <div
                                class="p-8 text-center bg-slate-50 dark:bg-slate-800/50 rounded-3xl border border-dashed border-slate-300 dark:border-slate-700">
                                <i class="fas fa-location-crosshairs text-2xl text-blue-600 mb-3 opacity-40"></i>
                                <p class="opacity-40 italic text-[10px] font-bold mb-4">Location access required to find
                                    nearby specialists.</p>
                                <button onclick="showLocationModal()"
                                    class="px-5 py-2.5 bg-blue-600 text-white rounded-xl text-[9px] font-black uppercase tracking-widest active:scale-95 transition-all">Activate
                                    Now</button>
                            </div>
                        </div>
                        <button onclick="showLocationModal()"
                            class="w-full mt-8 py-4 bg-slate-50 dark:bg-slate-800 text-[10px] font-black uppercase text-blue-500 hover:bg-blue-600 hover:text-white rounded-2xl transition-all tracking-widest shadow-sm">
                            <i class="fas fa-map-marked-alt mr-2"></i> Update Location
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- ACTIVITIES VIEW -->
        <section id="view-activities" class="hidden space-y-12">
            <div
                class="card p-8 bg-gradient-to-br from-emerald-600 to-teal-700 text-white border-none shadow-xl relative overflow-hidden">
                <div class="absolute right-0 top-0 w-1/3 h-full opacity-20 pointer-events-none">
                    <i class="fas fa-award text-[200px] -rotate-12 translate-x-20"></i>
                </div>
                <div class="relative z-10">
                    <h3 class="text-3xl font-black uppercase tracking-tight mb-2">Activities & Achievements</h3>
                    <p class="opacity-80 font-bold uppercase text-[11px] tracking-[4px]">Your Growth & Learning Progress
                    </p>
                </div>
            </div>

            <div class="grid lg:grid-cols-2 gap-8">
                <!-- KNOWLEDGE HUB (Moved from Expert) -->
                <div
                    class="card p-10 bg-white dark:bg-slate-900 border-none shadow-xl group cursor-pointer hover:shadow-2xl transition-all flex flex-col h-full">
                    <div
                        class="w-16 h-16 rounded-3xl bg-amber-500/10 text-amber-600 flex items-center justify-center text-3xl mb-8 group-hover:scale-110 transition-transform">
                        <i class="fas fa-book-open-reader"></i>
                    </div>
                    <h4 class="text-2xl font-black mb-4">Knowledge Hub</h4>
                    <p class="opacity-60 font-medium leading-relaxed mb-8">Access premium research papers, seasonal
                        calendars, and best practices for diverse crop types.</p>
                    <div class="space-y-4 mb-8">
                        <div class="flex items-center gap-4 p-4 rounded-2xl bg-slate-50 dark:bg-slate-800/50">
                            <i class="fas fa-file-pdf text-red-500"></i>
                            <span class="text-xs font-bold">Maize Sowing Guide 2026</span>
                        </div>
                        <div class="flex items-center gap-4 p-4 rounded-2xl bg-slate-50 dark:bg-slate-800/50">
                            <i class="fas fa-file-pdf text-red-500"></i>
                            <span class="text-xs font-bold">Fertilizer Optimization Protocols</span>
                        </div>
                    </div>
                    <button onclick="window.open('https://www.icar.org.in/', '_blank')"
                        class="w-full mt-auto py-4 bg-amber-500 text-white rounded-2xl font-black uppercase tracking-widest text-xs">Access
                        External Library</button>
                </div>

                <!-- CERTIFICATIONS (Moved from Expert) -->
                <div
                    class="card p-10 bg-white dark:bg-slate-900 border-none shadow-xl group cursor-pointer hover:shadow-2xl transition-all flex flex-col h-full">
                    <div
                        class="w-16 h-16 rounded-3xl bg-green-500/10 text-green-600 flex items-center justify-center text-3xl mb-8 group-hover:scale-110 transition-transform">
                        <i class="fas fa-award"></i>
                    </div>
                    <h4 class="text-2xl font-black mb-4">Certifications</h4>
                    <p class="opacity-60 font-medium leading-relaxed mb-8">Enroll in modern farming courses and earn
                        industry recognized certificates to boost your profile.</p>

                    <div class="grid grid-cols-2 gap-4 mb-8">
                        <div class="p-4 rounded-2xl bg-green-500/10 border border-green-500/20 text-center">
                            <p class="text-[10px] font-black uppercase text-green-600 mb-1">Active Course</p>
                            <p class="text-xs font-bold">Sustainable Soil Mgmt</p>
                        </div>
                        <div class="p-4 rounded-2xl bg-slate-50 dark:bg-slate-800/50 text-center">
                            <p class="text-[10px] font-black uppercase opacity-40 mb-1">Certificates</p>
                            <p class="text-xs font-bold">3 Earned</p>
                        </div>
                    </div>

                    <button onclick="window.open('https://swayam.gov.in/explorer?category=Agriculture', '_blank')"
                        class="w-full mt-auto py-4 bg-green-600 text-white rounded-2xl font-black uppercase tracking-widest text-xs">Explore
                        External Courses</button>
                </div>
            </div>

            <!-- ACTIVITIES GALLERY (Hero Style) -->
            <div class="card p-10 bg-white dark:bg-slate-900 border-none shadow-xl">
                <h4 class="text-xl font-black mb-8 flex items-center gap-3">
                    <i class="fas fa-images text-emerald-600"></i> Farming Success Gallery
                </h4>
                <div class="hero-box shadow-2xl relative overflow-hidden rounded-[40px]" style="height: 500px;">
                    <div class="hero-slides">
                        <img src="https://plus.unsplash.com/premium_photo-1682092016074-b136e1acb26e?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&ixid=M3wxMjA3fDB8MXxzZWFyY2h8MXx8aW5kaWFuJTIwYWdyaWN1bHR1cmV8ZW58MHx8fHwxNzcxODM5NzUzfDA&ixlib=rb-4.1.0&q=80&w=1080"
                            class="activities-slide active">
                        <img src="https://images.unsplash.com/photo-1683506684881-efbb5203eacf?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&ixid=M3wxMjA3fDB8MXxzZWFyY2h8Mnx8aW5kaWFuJTIwYWdyaWN1bHR1cmV8ZW58MHx8fHwxNzcxODM5NzUzfDA&ixlib=rb-4.1.0&q=80&w=1080"
                            class="activities-slide">
                        <img src="https://images.unsplash.com/photo-1600150806237-a7dffed6b53c?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&ixid=M3wxMjA3fDB8MXxzZWFyY2h8M3x8aW5kaWFuJTIwYWdyaWN1bHR1cmV8ZW58MHx8fHwxNzcxODM5NzUzfDA&ixlib=rb-4.1.0&q=80&w=1080"
                            class="activities-slide">
                        <img src="https://images.unsplash.com/photo-1530507629858-e4977d30e9e0?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&ixid=M3wxMjA3fDB8MXxzZWFyY2h8NHx8aW5kaWFuJTIwYWdyaWN1bHR1cmV8ZW58MHx8fHwxNzcxODM5NzUzfDA&ixlib=rb-4.1.0&q=80&w=1080"
                            class="activities-slide">
                        <img src="https://plus.unsplash.com/premium_photo-1682092112837-3dcf3e85ea6c?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&ixid=M3wxMjA3fDB8MXxzZWFyY2h8NXx8aW5kaWFuJTIwYWdyaWN1bHR1cmV8ZW58MHx8fHwxNzcxODM5NzUzfDA&ixlib=rb-4.1.0&q=80&w=1080"
                            class="activities-slide">
                        <img src="https://images.unsplash.com/photo-1520052203542-d3095f1b6cf0?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&ixid=M3wxMjA3fDB8MXxzZWFyY2h8Nnx8aW5kaWFuJTIwYWdyaWN1bHR1cmV8ZW58MHx8fHwxNzcxODM5NzUzfDA&ixlib=rb-4.1.0&q=80&w=1080"
                            class="activities-slide">
                        <img src="https://images.unsplash.com/photo-1624547481160-d564f43324f9?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&ixid=M3wxMjA3fDB8MXxzZWFyY2h8N3x8aW5kaWFuJTIwYWdyaWN1bHR1cmV8ZW58MHx8fHwxNzcxODM5NzUzfDA&ixlib=rb-4.1.0&q=80&w=1080"
                            class="activities-slide">
                        <img src="https://images.unsplash.com/flagged/photo-1576106035594-69a5d049173f?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&ixid=M3wxMjA3fDB8MXxzZWFyY2h8OHx8aW5kaWFuJTIwYWdyaWN1bHR1cmV8ZW58MHx8fHwxNzcxODM5NzUzfDA&ixlib=rb-4.1.0&q=80&w=1080"
                            class="activities-slide">
                        <img src="https://plus.unsplash.com/premium_photo-1661823013705-d58ac4788630?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&ixid=M3wxMjA3fDB8MXxzZWFyY2h8OXx8aW5kaWFuJTIwYWdyaWN1bHR1cmV8ZW58MHx8fHwxNzcxODM5NzUzfDA&ixlib=rb-4.1.0&q=80&w=1080"
                            class="activities-slide">
                        <img src="https://images.unsplash.com/photo-1623211270083-5743da6c67ec?crop=entropy&cs=tinysrgb&fit=max&fm=jpg&ixid=M3wxMjA3fDB8MXxzZWFyY2h8MTB8fGluZGlhbiUyMGFncmljdWx0dXJlfGVufDB8fHx8MTc3MTgzOTc1M3ww&ixlib=rb-4.1.0&q=80&w=1080"
                            class="activities-slide">
                    </div>
                    <div class="hero-overlay"></div>
                </div>
            </div>
        </section>

        <!-- SETTINGS VIEW -->
        <section id="view-settings" class="hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">

                <!-- PROFILE & FARM DETAILS -->
                <div class="card p-10 bg-white dark:bg-slate-900 border-none shadow-xl">
                    <h3 class="text-xl font-black mb-8 flex items-center gap-3 text-blue-600">
                        <i class="fas fa-user-circle"></i> Profile Management
                    </h3>
                    <div class="space-y-6">
                        <div
                            class="flex justify-between items-center p-4 rounded-2xl bg-slate-50 dark:bg-slate-800/50 hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors cursor-pointer group border border-transparent hover:border-blue-500/20">
                            <div>
                                <p class="font-bold">Personal Information</p>
                                <p class="text-xs opacity-50 mt-1">Name, Email, Phone</p>
                            </div>
                            <i
                                class="fas fa-chevron-right opacity-30 group-hover:translate-x-1 transition-transform"></i>
                        </div>
                        <div
                            class="flex justify-between items-center p-4 rounded-2xl bg-slate-50 dark:bg-slate-800/50 hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors cursor-pointer group border border-transparent hover:border-blue-500/20">
                            <div>
                                <p class="font-bold">Farm Details</p>
                                <p class="text-xs opacity-50 mt-1">Location, Size, Crops Grown</p>
                            </div>
                            <i
                                class="fas fa-chevron-right opacity-30 group-hover:translate-x-1 transition-transform"></i>
                        </div>
                        <div
                            class="flex justify-between items-center p-4 rounded-2xl bg-slate-50 dark:bg-slate-800/50 hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors cursor-pointer group border border-transparent hover:border-blue-500/20">
                            <div>
                                <p class="font-bold">Language Preference</p>
                                <p class="text-xs opacity-50 mt-1">English / Hindi / Regional</p>
                            </div>
                            <span
                                class="text-xs font-bold text-blue-600 px-3 py-1 bg-blue-100 dark:bg-blue-900/40 rounded-full">English</span>
                        </div>
                    </div>
                </div>

                <!-- NOTIFICATIONS & ALERTS -->
                <div class="card p-10 bg-white dark:bg-slate-900 border-none shadow-xl">
                    <h3 class="text-xl font-black mb-8 flex items-center gap-3 text-red-500">
                        <i class="fas fa-bell"></i> Alerts & Notifications
                    </h3>
                    <div class="space-y-6">
                        <div
                            class="flex justify-between items-center p-4 rounded-2xl bg-slate-50 dark:bg-slate-800/50 border border-transparent">
                            <div>
                                <p class="font-bold">Disease Outbreak Alerts</p>
                                <p class="text-xs opacity-50 mt-1">Regional AI threat warnings</p>
                            </div>
                            <div class="w-12 h-6 bg-blue-600 rounded-full relative cursor-pointer">
                                <div class="absolute right-1 top-1 w-4 h-4 bg-white rounded-full"></div>
                            </div>
                        </div>
                        <div
                            class="flex justify-between items-center p-4 rounded-2xl bg-slate-50 dark:bg-slate-800/50 border border-transparent">
                            <div>
                                <p class="font-bold">Weather Warnings</p>
                                <p class="text-xs opacity-50 mt-1">Rain, Drought, Frost alerts</p>
                            </div>
                            <div class="w-12 h-6 bg-blue-600 rounded-full relative cursor-pointer">
                                <div class="absolute right-1 top-1 w-4 h-4 bg-white rounded-full"></div>
                            </div>
                        </div>
                        <div
                            class="flex justify-between items-center p-4 rounded-2xl bg-slate-50 dark:bg-slate-800/50 border border-transparent">
                            <div>
                                <p class="font-bold">Mandi Price Tracking</p>
                                <p class="text-xs opacity-50 mt-1">Market price threshold alerts</p>
                            </div>
                            <div class="w-12 h-6 bg-slate-200 dark:bg-slate-700 rounded-full relative cursor-pointer">
                                <div class="absolute left-1 top-1 w-4 h-4 bg-white rounded-full transition-transform">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- CROP & REGIONAL SETTINGS -->
                <div class="card p-10 bg-white dark:bg-slate-900 border-none shadow-xl">
                    <h3 class="text-xl font-black mb-8 flex items-center gap-3 text-emerald-600">
                        <i class="fas fa-leaf"></i> Crop & Location Settings
                    </h3>
                    <div class="space-y-6">
                        <div
                            class="flex justify-between items-center p-4 rounded-2xl bg-slate-50 dark:bg-slate-800/50 hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors cursor-pointer group border border-transparent hover:border-emerald-500/20">
                            <div>
                                <p class="font-bold">Default Crop Profile</p>
                                <p class="text-xs opacity-50 mt-1">Current: Maize & Wheat</p>
                            </div>
                            <i class="fas fa-seedling opacity-30 group-hover:scale-110 transition-transform"></i>
                        </div>
                        <div
                            class="flex justify-between items-center p-4 rounded-2xl bg-slate-50 dark:bg-slate-800/50 hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors cursor-pointer group border border-transparent hover:border-emerald-500/20">
                            <div>
                                <p class="font-bold">Planting Calendar</p>
                                <p class="text-xs opacity-50 mt-1">Seasonal configurations</p>
                            </div>
                            <i
                                class="fas fa-calendar-alt opacity-30 group-hover:-translate-y-1 transition-transform"></i>
                        </div>
                        <div
                            class="flex justify-between items-center p-4 rounded-2xl bg-slate-50 dark:bg-slate-800/50 hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors cursor-pointer group border border-transparent hover:border-emerald-500/20">
                            <div>
                                <p class="font-bold">Local Mandi & Units</p>
                                <p class="text-xs opacity-50 mt-1">Currency: ‚Çπ / Area: Acres</p>
                            </div>
                            <i
                                class="fas fa-map-marker-alt opacity-30 group-hover:-translate-y-1 transition-transform"></i>
                        </div>
                    </div>
                </div>

                <!-- DATA, PRIVACY & SUPPORT -->
                <div class="card p-10 bg-white dark:bg-slate-900 border-none shadow-xl">
                    <h3 class="text-xl font-black mb-8 flex items-center gap-3 text-purple-500">
                        <i class="fas fa-shield-alt"></i> System & Privacy
                    </h3>
                    <div class="space-y-6">
                        <div
                            class="flex justify-between items-center p-4 rounded-2xl bg-slate-50 dark:bg-slate-800/50 hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors cursor-pointer group border border-transparent hover:border-purple-500/20">
                            <div>
                                <p class="font-bold">Data Privacy Controls</p>
                                <p class="text-xs opacity-50 mt-1">Manage farm location data sharing</p>
                            </div>
                            <i class="fas fa-lock opacity-30 group-hover:scale-110 transition-transform"></i>
                        </div>
                        <div
                            class="flex justify-between items-center p-4 rounded-2xl bg-slate-50 dark:bg-slate-800/50 hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors cursor-pointer group border border-transparent hover:border-purple-500/20">
                            <div>
                                <p class="font-bold">Export Farm Data</p>
                                <p class="text-xs opacity-50 mt-1">Download CSV/PDF analytics reports</p>
                            </div>
                            <i
                                class="fas fa-cloud-download-alt opacity-30 group-hover:translate-y-1 transition-transform"></i>
                        </div>
                        <div
                            class="flex justify-between items-center p-4 rounded-2xl bg-slate-50 dark:bg-slate-800/50 hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors cursor-pointer group border border-transparent hover:border-red-500/20">
                            <div>
                                <p class="font-bold text-red-500">Help & Support</p>
                                <p class="text-xs opacity-50 mt-1">Report Bugs / Contact Experts</p>
                            </div>
                            <i
                                class="fas fa-headset text-red-500 opacity-60 group-hover:scale-110 transition-transform"></i>
                        </div>
                    </div>
                </div>

            </div>
        </section>
        <!-- SETTINGS EDITOR MODAL -->
        <div id="settingsOverlay"
            class="hidden fixed inset-0 bg-black/60 backdrop-blur-md z-[3000] flex items-center justify-center p-4">
            <div
                class="card max-w-lg w-full p-8 bg-white dark:bg-slate-900 border-none shadow-2xl relative overflow-hidden text-left rounded-[32px]">
                <div class="flex justify-between items-center mb-6">
                    <h3 id="settingsModalTitle" class="text-2xl font-black">Edit Settings</h3>
                    <button onclick="document.getElementById('settingsOverlay').classList.add('hidden')"
                        class="w-10 h-10 rounded-2xl bg-slate-100 dark:bg-slate-800 flex items-center justify-center hover:bg-red-500 hover:text-white transition-all">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div id="settingsModalForm" class="space-y-4 max-h-[60vh] overflow-y-auto pr-2">
                    <!-- Dynamic content injected here -->
                </div>
                <button onclick="saveSettings()"
                    class="w-full mt-6 bg-blue-600 text-white rounded-2xl py-4 font-black uppercase text-xs tracking-widest hover:bg-blue-700 active:scale-95 transition-all shadow-lg shadow-blue-500/20">
                    Save Changes
                </button>
            </div>
        </div>

    </main>

    <!-- CUSTOM ERROR OVERLAY (MODAL) -->
    <div id="errorOverlay"
        class="hidden fixed inset-0 bg-black/60 backdrop-blur-md z-[1000] flex items-center justify-center p-4">
        <div id="errorView"
            class="card max-w-md w-full p-12 flex flex-col items-center justify-center text-center shadow-2xl border-2 border-red-500/20 transition-all duration-300">
            <div
                class="w-24 h-24 bg-red-100 dark:bg-red-900/40 text-red-600 rounded-3xl flex items-center justify-center text-4xl mb-8 animate-bounce shadow-lg">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <h3 class="text-3xl font-black text-red-600 mb-4 uppercase tracking-tight">Analysis Error</h3>
            <p class="text-lg font-bold opacity-70 mb-8" id="errorMessage">Please Upload a Valid Crop Image</p>
            <button onclick="resetScanner()"
                class="w-full bg-red-600 hover:bg-red-700 text-white font-black py-4 px-10 rounded-2xl transition-all active:scale-95 shadow-lg shadow-red-600/20 uppercase tracking-widest text-sm">
                Try Again
            </button>
        </div>
    </div>

    <!-- LOGIC VERIFICATION MODAL -->
    <div id="logicOverlay"
        class="hidden fixed inset-0 bg-black/80 backdrop-blur-xl z-[2000] flex items-center justify-center p-4">
        <div class="card max-w-xl w-full p-10 bg-slate-950 text-white border-none shadow-2xl relative overflow-hidden">
            <div class="relative z-10">
                <div class="flex justify-between items-start mb-10">
                    <div>
                        <h3 class="text-2xl font-black uppercase tracking-tight">Calculation Matrix</h3>
                        <p class="text-[10px] opacity-40 font-bold uppercase tracking-[4px]">Verified Factor Multipliers
                        </p>
                    </div>
                    <button onclick="document.getElementById('logicOverlay').classList.add('hidden')"
                        class="w-10 h-10 rounded-2xl bg-white/5 flex items-center justify-center hover:bg-white/10 transition-all">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div id="logicContent" class="grid grid-cols-2 gap-4">
                    <!-- JS Injects Factors -->
                </div>
                <div class="mt-10 pt-8 border-t border-white/5 flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div
                            class="w-10 h-10 rounded-2xl bg-green-500/10 flex items-center justify-center text-green-500">
                            <i class="fas fa-shield-check"></i>
                        </div>
                        <p class="text-[10px] font-bold uppercase opacity-40">Precision Verified<br>by AgriQuest Model
                        </p>
                    </div>
                    <p class="text-xs font-bold text-blue-500">v2.4.0-STABLE</p>
                </div>
                <div class="absolute -right-20 -top-20 w-80 h-80 bg-blue-600/10 blur-[100px] rounded-full"></div>
            </div>
        </div>
    </div>

    <!-- DREAM 11 STYLE AUTH MODAL -->
    <div id="authModal"
        class="hidden fixed inset-0 z-[5000] flex items-end sm:items-center justify-center p-0 sm:p-4 transition-all duration-300">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm" onclick="toggleAuthModal()"></div>

        <div id="authCard"
            class="auth-card relative w-full sm:max-w-md bg-white dark:bg-slate-950 overflow-hidden shadow-2xl z-10 flex flex-col">
            <!-- BRAND TOP SECTION -->
            <div
                class="h-44 sm:h-48 bg-gradient-to-br from-[#E10000] to-[#8B0000] p-8 flex flex-col justify-end relative">
                <div class="absolute top-6 right-6">
                    <button onclick="toggleAuthModal()"
                        class="w-10 h-10 rounded-full bg-white/10 flex items-center justify-center text-white hover:bg-white/20 transition-all">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 opacity-10">
                    <i class="fas fa-leaf text-[150px] text-white"></i>
                </div>
                <div class="relative z-10">
                    <h3 id="authTitle" class="text-3xl font-black text-white uppercase tracking-tight leading-none">
                        Login</h3>
                    <p id="authSubtitle" class="text-white/60 text-[10px] font-black uppercase tracking-[3px] mt-2">
                        AgriQuest Command Center</p>
                </div>
            </div>

            <div class="p-8 sm:p-10 space-y-8">
                <!-- FORM CONTAINER (Login) -->
                <div id="loginForm" class="space-y-6">
                    <div class="space-y-4">
                        <div class="relative group">
                            <label
                                class="text-[10px] absolute -top-2 left-4 px-2 bg-white dark:bg-slate-950 text-[#E10000] font-black uppercase tracking-widest z-10">Identity</label>
                            <input type="text" id="lUser"
                                class="w-full h-16 px-6 pt-2 rounded-2xl border-2 border-slate-100 dark:border-slate-800 bg-transparent focus:border-[#E10000] transition-all outline-none font-bold"
                                placeholder="Username or Phone">
                        </div>
                        <div class="relative group">
                            <label
                                class="text-[10px] absolute -top-2 left-4 px-2 bg-white dark:bg-slate-950 text-[#E10000] font-black uppercase tracking-widest z-10">Secret
                                Key</label>
                            <input type="password" id="lPass"
                                class="w-full h-16 px-6 pt-2 rounded-2xl border-2 border-slate-100 dark:border-slate-800 bg-transparent focus:border-[#E10000] transition-all outline-none font-bold"
                                placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                        </div>
                    </div>
                    <button onclick="login(event)"
                        class="w-full h-16 bg-[#E10000] hover:bg-[#C10000] text-white rounded-2xl font-black text-base uppercase tracking-widest transition-all active:scale-95 shadow-xl shadow-red-500/20">LOG
                        IN</button>

                    <div class="flex items-center gap-4 py-2">
                        <div class="flex-1 h-px bg-slate-200 dark:bg-slate-800"></div>
                        <span class="text-[10px] font-black text-slate-400 uppercase tracking-widest">OR CONNECT
                            WITH</span>
                        <div class="flex-1 h-px bg-slate-200 dark:bg-slate-800"></div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <button
                            class="h-14 rounded-2xl border-2 border-slate-100 dark:border-slate-800 flex items-center justify-center gap-2 hover:bg-slate-50 dark:hover:bg-slate-900 transition-all font-bold text-xs uppercase">
                            <img src="https://upload.wikimedia.org/wikipedia/commons/5/53/Google_%22G%22_Logo.svg"
                                class="w-4 h-4"> Google
                        </button>
                        <button
                            class="h-14 rounded-2xl border-2 border-slate-100 dark:border-slate-800 flex items-center justify-center gap-2 hover:bg-slate-50 dark:hover:bg-slate-900 transition-all font-bold text-xs uppercase">
                            <i class="fab fa-facebook text-blue-600 text-lg"></i> Facebook
                        </button>
                    </div>

                    <p class="text-center text-xs font-bold text-slate-500">
                        New Member? <button type="button"
                            class="text-[#E10000] cursor-pointer font-black hover:underline"
                            onclick="toggleAuthView('reg')">Register Here</button>
                    </p>
                </div>

                <!-- REGISTER FORM -->
                <div id="regForm" class="hidden space-y-6">
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-3">
                            <div class="relative group">
                                <label
                                    class="text-[10px] absolute -top-2 left-4 px-2 bg-white dark:bg-slate-950 text-green-600 font-black uppercase tracking-widest z-10">Username</label>
                                <input type="text" id="rUser"
                                    class="w-full h-16 px-6 pt-2 rounded-2xl border-2 border-slate-100 dark:border-slate-800 bg-transparent focus:border-green-500 transition-all outline-none font-bold"
                                    placeholder="agri_pro">
                            </div>
                            <div class="relative group">
                                <label
                                    class="text-[10px] absolute -top-2 left-4 px-2 bg-white dark:bg-slate-950 text-green-600 font-black uppercase tracking-widest z-10">Mobile
                                    No</label>
                                <input type="tel" id="rPhone"
                                    class="w-full h-16 px-6 pt-2 rounded-2xl border-2 border-slate-100 dark:border-slate-800 bg-transparent focus:border-green-500 transition-all outline-none font-bold"
                                    placeholder="9876543210">
                            </div>
                        </div>
                        <div class="relative group">
                            <label
                                class="text-[10px] absolute -top-2 left-4 px-2 bg-white dark:bg-slate-950 text-green-600 font-black uppercase tracking-widest z-10">Email
                                Address</label>
                            <input type="email" id="rEmail"
                                class="w-full h-16 px-6 pt-2 rounded-2xl border-2 border-slate-100 dark:border-slate-800 bg-transparent focus:border-green-500 transition-all outline-none font-bold"
                                placeholder="farmer@quest.com">
                        </div>
                        <div class="relative group">
                            <label
                                class="text-[10px] absolute -top-2 left-4 px-2 bg-white dark:bg-slate-950 text-green-600 font-black uppercase tracking-widest z-10">Secure
                                Password</label>
                            <input type="password" id="rPass"
                                class="w-full h-16 px-6 pt-2 rounded-2xl border-2 border-slate-100 dark:border-slate-800 bg-transparent focus:border-green-500 transition-all outline-none font-bold"
                                placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                        </div>
                    </div>
                    <button onclick="register()"
                        class="w-full h-16 bg-green-600 hover:bg-green-700 text-white rounded-2xl font-black text-base uppercase tracking-widest transition-all active:scale-95 shadow-xl shadow-green-500/20">CREATE
                        ACCOUNT</button>
                    <p class="text-center text-xs font-bold text-slate-500">
                        Already have an account? <button type="button"
                            class="text-[#E10000] cursor-pointer font-black hover:underline"
                            onclick="toggleAuthView('login')">Login Now</button>
                    </p>
                </div>
            </div>

            <div class="p-6 bg-slate-50 dark:bg-slate-900 text-center">
                <p class="text-[9px] font-bold text-slate-400 uppercase tracking-widest">By logging in, you agree to our
                    <span class="text-slate-600 dark:text-slate-200 underline">Terms of Hub</span>
                </p>
            </div>
        </div>
    </div>

    <!-- LOCATION SELECTION MODAL (POST-LOGIN) -->
    <div id="locationModal" class="hidden fixed inset-0 z-[6000] flex flex-col items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/80 backdrop-blur-xl" onclick="closeLocationModal()"></div>
        <div
            class="relative w-full max-w-[400px] bg-white dark:bg-slate-900 rounded-2xl overflow-hidden shadow-2xl p-6 text-left my-auto">
            <div
                class="w-12 h-12 rounded-full bg-blue-50 dark:bg-blue-900/30 flex items-center justify-center text-blue-600 mb-4">
                <i class="fas fa-map-marker-alt text-2xl"></i>
            </div>
            <h3 class="text-xl font-medium text-slate-900 dark:text-white mb-2">Use your location</h3>
            <p class="text-sm text-slate-600 dark:text-slate-300 mb-6 leading-relaxed">To see Mandi markets near you,
                get accurate transport costs, and receive relevant price updates, allow AgriQuest to use your location.
            </p>

            <div class="space-y-4">
                <button onclick="useCurrentLocation()"
                    class="w-full bg-blue-600 hover:bg-blue-700 active:bg-blue-800 text-white font-medium py-2.5 rounded-full transition-colors">
                    Allow location access
                </button>

                <div class="flex items-center gap-3 py-1">
                    <div class="flex-1 h-px bg-slate-200 dark:bg-slate-800"></div>
                    <span class="text-xs text-slate-400 font-medium">OR</span>
                    <div class="flex-1 h-px bg-slate-200 dark:bg-slate-800"></div>
                </div>

                <div class="flex items-center gap-2">
                    <input type="text" id="manualLocation"
                        class="flex-1 bg-slate-50 dark:bg-slate-800 border border-slate-200 dark:border-slate-700 text-slate-900 dark:text-white rounded-full px-4 py-2.5 text-sm focus:outline-none focus:border-blue-500 transition-colors"
                        placeholder="Enter town or APMC">
                    <button onclick="saveManualLocation()"
                        class="bg-slate-100 dark:bg-slate-800 hover:bg-slate-200 dark:hover:bg-slate-700 text-slate-700 dark:text-slate-200 font-medium px-5 py-2.5 rounded-full transition-colors text-sm">
                        Save
                    </button>
                </div>
            </div>

            <button onclick="closeLocationModal()"
                class="absolute top-4 right-4 w-8 h-8 flex items-center justify-center rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-400 transition-colors">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>

    <script>
        const state = { theme: localStorage.getItem('aq_theme') || 'light' };

        function updateThemeUI() {
            document.body.className = state.theme;
            localStorage.setItem('aq_theme', state.theme);
        }

        function toggleMode() {
            state.theme = state.theme === 'light' ? 'dark' : 'light';
            updateThemeUI();

            // Re-render charts for theme consistency if data exists
            if (yieldChartObj || marketChartObj) {
                const fd = new FormData(document.getElementById('yForm'));
                const labels = Array.from(document.querySelectorAll('input[name="crops"]:checked')).map(c => c.value);
                // Simple re-render with existing data would be better, but for now we reset
            }
        }

        function setView(name) {
            document.querySelectorAll('section').forEach(s => s.classList.add('hidden'));
            document.querySelectorAll('.nav-item').forEach(l => l.classList.remove('active'));
            const target = document.getElementById(`view-${name}`);
            if (target) target.classList.remove('hidden');
            const navLink = document.getElementById(`nav-${name}`);
            if (navLink) navLink.classList.add('active');

            // Auto reset scanner views when switching
            resetScanner();
            window.activeView = name;

            if (name === 'history') loadHistory();
            if (name === 'expert') loadNearbyExperts();
            if (name === 'radar') initRadar();

            const paths = {
                dashboard: 'Main Hub',
                scan: 'Analysis Port',
                yield: 'Forecast Engine',
                history: 'Archives',
                markets: 'Market Pulse',
                radar: 'Global Radar',
                expert: 'Agri-Expert',
                activities: 'Achievements Hub',
                settings: 'Control Panel'
            };
            const titles = {
                dashboard: 'Overview',
                scan: 'Disease Scan',
                yield: 'Yield Forecast',
                history: 'Activity Logs',
                markets: 'Mandi Markets',
                radar: 'Live Radar',
                expert: 'Expert Help',
                activities: 'Activities',
                settings: 'App Settings'
            };

            document.getElementById('path').textContent = paths[name] || 'App';
            document.getElementById('v-title').textContent = titles[name] || 'AgriQuest';

            if (name === 'markets') {
                setTimeout(renderMarketDetailChart, 100);
            }

            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function resetScanner() {
            document.getElementById('results')?.classList.add('hidden');
            document.getElementById('errorOverlay')?.classList.add('hidden');
            document.getElementById('loading')?.classList.add('hidden');
            document.getElementById('empty')?.classList.remove('hidden');
            document.getElementById('remedyCard')?.classList.add('hidden');

            // Yield Resets
            document.getElementById('ySummary')?.classList.add('hidden');
            document.getElementById('yAnalytics')?.classList.add('hidden');
            document.getElementById('yChartPanel')?.classList.add('hidden');
        }

        // CAROUSEL LOGIC
        let slideIdx = 0;
        const slides = document.querySelectorAll('.hero-slide');
        function rotateSlides() {
            slides[slideIdx].classList.remove('active');
            slideIdx = (slideIdx + 1) % slides.length;
            slides[slideIdx].classList.add('active');
        }
        setInterval(rotateSlides, 4000);

        let actSlideIdx = 0;
        function rotateActivitiesSlides() {
            const actSlides = document.querySelectorAll('.activities-slide');
            if (actSlides.length === 0) return;
            actSlides[actSlideIdx].classList.remove('active');
            actSlideIdx = (actSlideIdx + 1) % actSlides.length;
            actSlides[actSlideIdx].classList.add('active');
        }
        setInterval(rotateActivitiesSlides, 4000);

        // SCANNER AGENT CONTROLS
        let scanMode = 'upload';
        let stream = null;
        let currentFacingMode = 'environment';
        let capturedBlob = null;

        function setScanMode(mode) {
            scanMode = mode;
            document.querySelectorAll('.scan-mode-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`mode-${mode}`).classList.add('active');
            document.querySelectorAll('.scan-area').forEach(a => a.classList.add('hidden'));
            document.getElementById(`area-${mode}`).classList.remove('hidden');

            if (mode === 'camera') {
                startCamera();
            } else {
                stopCamera();
            }
        }

        async function startCamera() {
            try {
                if (stream) stopCamera();
                const constraints = {
                    video: { facingMode: currentFacingMode }
                };
                stream = await navigator.mediaDevices.getUserMedia(constraints);
                document.getElementById('video').srcObject = stream;
            } catch (err) {
                alert("Camera access denied or unavailable.");
            }
        }

        function stopCamera() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
        }

        function switchCamera() {
            currentFacingMode = currentFacingMode === 'user' ? 'environment' : 'user';
            startCamera();
        }

        function capturePhoto() {
            const video = document.getElementById('video');
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0);

            canvas.toBlob((blob) => {
                capturedBlob = blob;
                const url = URL.createObjectURL(blob);
                document.getElementById('tImg').src = url;
                document.getElementById('prev').classList.remove('hidden');
                document.getElementById('area-camera').classList.add('hidden');
            }, 'image/jpeg');
        }



        function clearSelection() {
            document.getElementById('tImg').src = '';
            document.getElementById('prev').classList.add('hidden');
            document.getElementById('img').value = '';
            capturedBlob = null;
            if (scanMode === 'camera') {
                document.getElementById('area-camera').classList.remove('hidden');
            }
        }

        const iInp = document.getElementById('img');
        iInp.onchange = (e) => {
            const f = e.target.files[0];
            if (f) {
                const r = new FileReader();
                r.onload = (ev) => {
                    document.getElementById('tImg').src = ev.target.result;
                    document.getElementById('prev').classList.remove('hidden');
                };
                r.readAsDataURL(f);
            }
        };

        const REMEDIES_DATA = {
            'healthy': {
                rem: ['Continue current irrigation.', 'Apply micronutrients.', 'Document crop growth stage.'],
                pre: ['Avoid excessive nitrogen.', 'Keep field borders clear of weeds.', 'Sanitize boots before entering field.']
            },
            'Common_Rust': {
                rem: ['Use pyraclostrobin fungicide.', 'Increase potassium levels.', 'Early harvesting if severe.'],
                pre: ['Space plants for airflow.', 'Avoid morning watering.', 'Select resistant hybrids.']
            },
            'Blight': {
                rem: ['Apply strobilurin fungicides.', 'Burrow infected residue.', 'Reduce crop density.'],
                pre: ['Never work in wet fields.', 'Disinfect high-touch tools.', 'Maintain strict crop rotation.']
            },
            'Gray_Leaf_Spot': {
                rem: ['Foliar fungicide application.', 'Tillage to bury inoculum.', 'Balanced fertilization.'],
                pre: ['Avoid back-to-back corn.', 'Monitor weather (high humidity).', 'Clear stagnant water areas.']
            },
            'Smut': {
                rem: ['Remove and burn infected heads.', 'Apply carboxin seed treatment next season.', 'Avoid using seeds from this field.'],
                pre: ['Use certified disease-free seeds.', 'Practice 3-year crop rotation.', 'Solarization of soil in summer.']
            },
            'Yellow Rust': {
                rem: ['Apply Propiconazole or Tebuconazole fungicide.', 'Improve soil drainage.', 'Monitor spread to nearby fields.'],
                pre: ['Select resistant varieties (e.g., HD-2967).', 'Avoid late sowing.', 'Check fields weekly after first rain.']
            },
            'Leaf Blight': {
                rem: ['Apply mancozeb or chlorothalonil fungicide.', 'Remove heavily infected lower leaves.', 'Mulch the soil to prevent spore splash.'],
                pre: ['Avoid overhead watering.', 'Stake plants for better airflow.', 'Practice 2-year crop rotation.']
            },
            'Bacterial Spot': {
                rem: ['Apply copper-based fungicides.', 'Use streptomycin if recommended locally.', 'Rotate with non-host crops like corn.'],
                pre: ['Use certified disease-free seeds.', 'Do not work in wet fields.', 'Sanitize tools after pruning.']
            },
            'unhealthy': {
                rem: ['Consult local agri-officer.', 'Test soil for deficiencies.', 'Apply broad-spectrum fungicide.'],
                pre: ['Isolate the plot immediately.', 'Limit human traffic in area.', 'Mark the discovery date.']
            }
        };

        function populateRemedies(res) {
            const h = res.health_status === 'healthy';
            const remCard = document.getElementById('remedyCard');
            const remList = document.getElementById('remedyList');
            const preList = document.getElementById('precautionList');

            remList.innerHTML = '';
            preList.innerHTML = '';
            remCard.classList.remove('hidden');

            const activeData = h ? REMEDIES_DATA['healthy'] : (REMEDIES_DATA[res.disease_name] || REMEDIES_DATA['unhealthy']);

            activeData.rem.forEach(r => {
                const li = document.createElement('li');
                li.textContent = r;
                remList.appendChild(li);
            });

            activeData.pre.forEach(p => {
                const li = document.createElement('li');
                li.textContent = p;
                preList.appendChild(li);
            });
        }

        document.getElementById('scanBtn').onclick = async () => {
            let fileData = null;
            if (scanMode === 'upload' && iInp.files[0]) {
                fileData = iInp.files[0];
            } else if (scanMode === 'camera' && capturedBlob) {
                fileData = new File([capturedBlob], "capture.jpg", { type: "image/jpeg" });
            }

            if (!fileData) return;

            document.getElementById('empty').classList.add('hidden');
            document.getElementById('results').classList.add('hidden');
            document.getElementById('loading').classList.remove('hidden');

            const fd = new FormData();
            if (fileData) fd.append('file', fileData);
            fd.append('crop_type', document.getElementById('cropType').value);
            try {
                const res = await fetch('/api/predict', { method: 'POST', body: fd }).then(r => r.json());

                if (res.error) {
                    document.getElementById('loading').classList.add('hidden');
                    document.getElementById('errorMessage').textContent = res.error || "Please Upload a Valid Crop Image";
                    document.getElementById('errorOverlay').classList.remove('hidden');
                    document.getElementById('empty').classList.remove('hidden');
                    return;
                }

                document.getElementById('loading').classList.add('hidden');
                document.getElementById('results').classList.remove('hidden');
                const h = res.health_status === 'healthy';
                document.getElementById('stText').textContent = res.health_status;
                document.getElementById('stText').className = h ? "text-5xl font-black text-green-500 uppercase" : "text-5xl font-black text-white uppercase";
                document.getElementById('stCard').className = h ? "p-10 rounded-[36px] bg-green-500/10 border border-green-500/20 text-center" : "p-10 rounded-[36px] bg-red-600 text-white shadow-xl text-center";
                document.getElementById('cfText').textContent = `${(res.confidence * 100).toFixed(1)}%`;
                if (!h) {
                    document.getElementById('disBox').classList.remove('hidden');
                    document.getElementById('disName').textContent = res.disease_name;
                } else { document.getElementById('disBox').classList.add('hidden'); }

                // AI MEMORY: Save scan context
                window.lastScanResult = res;
                populateRemedies(res);
            } catch (e) { console.error(e); }
        };

        // Global Chart Controllers
        let yieldChartObj = null;
        let marketChartObj = null;
        let marketDetailChartObj = null;

        document.getElementById('yForm').onsubmit = async (e) => {
            e.preventDefault();
            const fd = new FormData(e.target);
            const data = Object.fromEntries(fd);
            data.crops = Array.from(e.target.querySelectorAll('input[name="crops"]:checked')).map(c => c.value);

            if (data.crops.length === 0) {
                showValidationError("Security Check: Please select at least one Crop type for analysis.");
                return;
            }

            try {
                const res = await fetch('/api/predict_yield', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                }).then(r => r.json());

                // Reveal Panels
                document.getElementById('ySummary').classList.remove('hidden');
                document.getElementById('yAnalytics').classList.remove('hidden');
                document.getElementById('yChartPanel').classList.remove('hidden');

                // Valuation & Stats
                document.getElementById('yVal').textContent = `‚Çπ ${res.total_estimated_value.toLocaleString('en-IN')}`;
                document.getElementById('yProfit').textContent = `‚Çπ ${res.total_profit.toLocaleString('en-IN')}`;
                document.getElementById('yScore').textContent = `${res.suitability_score}%`;

                // Risk Badge Styling
                const riskEl = document.getElementById('yRisk');
                const riskBadge = document.getElementById('yRiskBadge');
                riskEl.textContent = res.risk_level;
                if (res.risk_level === 'HIGH') {
                    riskBadge.className = "p-3 rounded-2xl bg-red-500/10 border border-red-500/20 text-center min-w-[120px]";
                    riskEl.className = "text-sm font-black text-red-500";
                } else if (res.risk_level === 'MEDIUM') {
                    riskBadge.className = "p-3 rounded-2xl bg-amber-500/10 border border-amber-500/20 text-center min-w-[120px]";
                    riskEl.className = "text-sm font-black text-amber-500";
                } else {
                    riskBadge.className = "p-3 rounded-2xl bg-green-500/10 border border-green-500/20 text-center min-w-[120px]";
                    riskEl.className = "text-sm font-black text-green-500";
                }

                // Inset Crop Cards
                const rows = document.getElementById('yRows');
                rows.innerHTML = '';
                res.predictions.forEach(p => {
                    const card = document.createElement('div');
                    card.className = "p-6 rounded-3xl bg-white/5 border border-white/10 hover:bg-white/10 transition-all group";
                    card.innerHTML = `
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <p class="text-[10px] uppercase font-bold opacity-40 mb-1">${p.crop_type}</p>
                                <p class="text-xl font-black">${p.predicted_yield_tons} <span class="text-xs opacity-40">TONS</span></p>
                            </div>
                            <div class="text-right">
                                <p class="text-[9px] uppercase font-bold text-green-500">${p.roi}% ROI</p>
                                <p class="text-xs font-bold text-blue-400">‚Çπ ${(p.market_price_est / 1000).toFixed(1)}K</p>
                            </div>
                        </div>
                        <div class="space-y-2">
                             <div class="flex justify-between text-[9px] font-bold opacity-30 uppercase">
                                <span>Yield/Acre</span>
                                <span>Break-even</span>
                             </div>
                             <div class="flex justify-between text-xs font-bold">
                                <span>${p.yield_per_acre} T</span>
                                <span>${p.break_even_tons} T</span>
                             </div>
                             <div class="w-full h-1 bg-white/5 rounded-full mt-2 overflow-hidden">
                                <div class="h-full bg-blue-500" style="width: ${Math.min(100, (p.predicted_yield_tons / p.break_even_tons) * 50)}%"></div>
                             </div>
                        </div>
                    `;
                    rows.appendChild(card);
                });

                // Updates Insights
                const insList = document.getElementById('insightList');
                insList.innerHTML = '';
                res.insights.forEach(ins => {
                    const li = document.createElement('li');
                    li.className = "flex items-start gap-3 p-3 rounded-2xl bg-slate-50 dark:bg-slate-800/50 border border-transparent hover:border-blue-500/30 transition-all";
                    li.innerHTML = `<i class="fas fa-circle-check mt-1 text-blue-500 shadow-lg shadow-blue-500/20"></i> <span class="text-xs font-medium leading-relaxed">${ins}</span>`;
                    insList.appendChild(li);
                });

                // RENDER CHARTS
                renderYieldCharts(res.charts, res.predictions.map(p => p.crop_type), res.predictions.map(p => p.predicted_yield_tons));

                // Save for margin calculator
                window.lastYieldPrediction = res.predictions[0];
                window.lastFactors = res.factors;

                // Sync with Dashboard Overview
                const prof = res.total_estimated_value;
                document.getElementById('dash-profit').textContent = `‚Çπ ${(prof / 100000).toFixed(1)}L`;
                document.getElementById('dash-soil-ph').textContent = `${data.ph || 6.8} pH`;

            } catch (e) { console.error(e); }
        };

        function showCalculation() {
            if (!window.lastFactors) {
                showValidationError("Security Alert: Please run a forecast first to generate calculation factors.");
                return;
            }
            const content = document.getElementById('logicContent');
            content.innerHTML = '';

            const mapping = {
                rainfall: { label: 'Rainfall Factor', icon: 'fa-cloud-rain' },
                temperature: { label: 'Thermal Factor', icon: 'fa-temperature-high' },
                humidity: { label: 'Atmospheric Factor', icon: 'fa-droplet' },
                ph: { label: 'Acidic Balance', icon: 'fa-flask-vial' },
                nutrients: { label: 'Nutrient Bio-Load', icon: 'fa-atom' },
                soil: { label: 'Geological Factor', icon: 'fa-mountain' },
                organic: { label: 'Organic Matter %', icon: 'fa-leaf' }
            };

            Object.entries(window.lastFactors).forEach(([key, val]) => {
                const item = mapping[key];
                const card = document.createElement('div');
                card.className = "p-5 rounded-3xl bg-white/5 border border-white/10 flex flex-col gap-2";
                card.innerHTML = `
                    <div class="flex justify-between items-center text-blue-400">
                        <i class="fas ${item.icon} text-lg"></i>
                        <span class="text-xl font-black">${val}x</span>
                    </div>
                    <p class="text-[9px] font-bold uppercase opacity-40 tracking-widest">${item.label}</p>
                `;
                content.appendChild(card);
            });

            document.getElementById('logicOverlay').classList.remove('hidden');
        }

        function renderMarketDetailChart(labels, dataValues) {
            const ctx = document.getElementById('marketDetailChart').getContext('2d');
            if (marketDetailChartObj) marketDetailChartObj.destroy();

            const isDark = document.body.classList.contains('dark');
            const color = isDark ? '#3b82f6' : '#2563eb';

            marketDetailChartObj = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels || ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                    datasets: [{
                        label: 'Market Average (‚Çπ)',
                        data: dataValues || [2050, 2080, 2120, 2150, 2140, 2160, 2185],
                        borderColor: color,
                        backgroundColor: isDark ? 'rgba(59, 130, 246, 0.1)' : 'rgba(37, 99, 235, 0.05)',
                        fill: true,
                        tension: 0.4,
                        borderWidth: 3,
                        pointBackgroundColor: color,
                        pointRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: {
                            beginAtZero: false,
                            grid: { color: isDark ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.05)' },
                            ticks: { color: isDark ? '#64748b' : '#94a3b8', font: { size: 10, weight: 'bold' } }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: isDark ? '#64748b' : '#94a3b8', font: { size: 10, weight: 'bold' } }
                        }
                    }
                }
            });
        }

        function updateMarketChart(range) {
            const d7 = {
                labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                data: [2050, 2080, 2120, 2150, 2140, 2160, 2185]
            };
            const d30 = {
                labels: ['W1', 'W2', 'W3', 'W4'],
                data: [1980, 2040, 2100, 2185]
            };

            const data = range === '7d' ? d7 : d30;
            renderMarketDetailChart(data.labels, data.data);

            // UI State
            const btn7 = document.getElementById('btn-7d');
            const btn30 = document.getElementById('btn-30d');
            if (range === '7d') {
                btn7.className = "px-3 py-1 rounded-lg bg-blue-600 text-white text-[9px] font-black uppercase";
                btn30.className = "px-3 py-1 rounded-lg bg-slate-100 dark:bg-slate-800 text-[9px] font-black uppercase opacity-50";
            } else {
                btn30.className = "px-3 py-1 rounded-lg bg-blue-600 text-white text-[9px] font-black uppercase";
                btn7.className = "px-3 py-1 rounded-lg bg-slate-100 dark:bg-slate-800 text-[9px] font-black uppercase opacity-50";
            }
        }

        function openMandiMap() {
            // Opens Google Maps showing nearby Mandis (APMC)
            window.open('https://www.google.com/maps/search/APMC+Mandi+near+me', '_blank');
        }

        function calculateMargin() {
            const price = parseFloat(document.getElementById('mPrice').value) || 0;
            const transport = parseFloat(document.getElementById('mTransport').value) || 0;

            // Use real yield if available, else default
            const yieldAcre = window.lastYieldPrediction ? window.lastYieldPrediction.yield_per_acre : 8.5;
            if (window.lastYieldPrediction) {
                console.log("Using dynamic yield from forecast:", yieldAcre);
            }

            const totalRevenue = price * yieldAcre * 10; // per quintal to tons
            const netMargin = (price * 10) - (transport / yieldAcre); // Rough approx
            const displayMargin = (price * yieldAcre) - transport;

            document.getElementById('mResult').textContent = `‚Çπ ${Math.max(0, displayMargin).toLocaleString('en-IN')}`;
            const percentage = Math.min(100, (displayMargin / 25000) * 100);
            document.getElementById('mBar').style.width = `${percentage}%`;
        }

        function renderYieldCharts(chartData, labels, yieldValues) {
            const ctx1 = document.getElementById('yieldChart').getContext('2d');
            const ctx2 = document.getElementById('marketChart').getContext('2d');

            if (yieldChartObj) yieldChartObj.destroy();
            if (marketChartObj) marketChartObj.destroy();

            const isDark = document.documentElement.classList.contains('dark');
            const textColor = isDark ? '#94a3b8' : '#64748b';

            yieldChartObj = new Chart(ctx1, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Projected Yield (Tons)',
                        data: yieldValues, // REAL DATA
                        backgroundColor: '#3b82f6',
                        borderRadius: 8,
                        barThickness: 20
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { display: false },
                        x: { ticks: { color: textColor, font: { size: 9, weight: 'bold' } }, grid: { display: false } }
                    }
                }
            });

            marketChartObj = new Chart(ctx2, {
                type: 'line',
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                    datasets: [{
                        label: 'Mandi Price Trend',
                        data: [1800, 1950, 2100, 2050, 2200, 2400, 2350, 2500, 2450, 2600, 2550, 2700],
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        fill: true,
                        tension: 0.4,
                        borderWidth: 3,
                        pointRadius: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { ticks: { color: textColor, font: { size: 10 } }, grid: { color: isDark ? 'rgba(255,255,255,0.05)' : 'rgba(0,0,0,0.05)' } },
                        x: { ticks: { color: textColor, font: { size: 10 } }, grid: { display: false } }
                    }
                }
            });
        }

        async function loadHistory() {
            const list = document.getElementById('historyList');
            try {
                const response = await fetch('/api/history');
                if (response.status === 401) {
                    list.innerHTML = `<div class="p-10 text-center opacity-50 font-bold">Session expired. Please <span class="text-blue-500 cursor-pointer" onclick="toggleAuthModal()">Login again</span> to view history.</div>`;
                    return;
                }
                const res = await response.json();

                if (res.length === 0) {
                    list.innerHTML = `<div class="p-10 text-center opacity-50 font-bold">No recent activities found in your archive.</div>`;
                    return;
                }

                list.innerHTML = res.map((h, i) => `
                    <div class="flex items-center justify-between p-6 rounded-3xl bg-slate-50 dark:bg-slate-900 border border-transparent hover:border-blue-500/20 transition-all group">
                        <div class="flex items-center gap-6">
                            <div class="w-14 h-14 rounded-2xl bg-white dark:bg-slate-800 flex items-center justify-center text-xl shadow-sm">
                                <i class="fas ${h.type === 'disease' ? 'fa-virus' : 'fa-chart-pie'} ${h.type === 'disease' ? 'text-red-500' : 'text-blue-500'}"></i>
                            </div>
                            <div>
                                <h4 class="font-black text-lg capitalize">${h.crop_type} ${h.type} Analysis</h4>
                                <p class="text-xs font-bold opacity-30 mt-1 uppercase tracking-widest">${h.timestamp}</p>
                            </div>
                        </div>
                        <button onclick='viewHistoryItem(${JSON.stringify(h).replace(/'/g, "&apos;")})' class="px-6 py-3 rounded-xl bg-blue-600 text-white font-black text-xs hover:bg-blue-700 transition-all active:scale-95 shadow-lg shadow-blue-600/20 uppercase">
                            View Result
                        </button>
                    </div>
                `).join('');
            } catch (e) {
                list.innerHTML = `<div class="p-10 text-center text-red-500 font-bold">Session expired. Please login again.</div>`;
            }
        }




        function viewHistoryItem(item) {
            setView(item.type === 'disease' ? 'scan' : 'yield');
            const res = item.result;

            if (item.type === 'disease') {
                document.getElementById('empty').classList.add('hidden');
                document.getElementById('results').classList.remove('hidden');
                const h = res.health_status === 'healthy';
                document.getElementById('stText').textContent = res.health_status;
                document.getElementById('stText').className = h ? "text-5xl font-black text-green-500 uppercase" : "text-5xl font-black text-white uppercase";
                document.getElementById('stCard').className = h ? "p-10 rounded-[36px] bg-green-500/10 border border-green-500/20 text-center" : "p-10 rounded-[36px] bg-red-600 text-white shadow-xl text-center";
                document.getElementById('cfText').textContent = `${(res.confidence * 100).toFixed(1)}%`;
                if (!h) {
                    document.getElementById('disBox').classList.remove('hidden');
                    document.getElementById('disName').textContent = res.disease_name;
                } else {
                    document.getElementById('disBox').classList.add('hidden');
                }

                // Populate Remedies
                const remCard = document.getElementById('remedyCard');
                const remList = document.getElementById('remedyList');
                const preList = document.getElementById('precautionList');
                remList.innerHTML = '';
                preList.innerHTML = '';
                remCard.classList.remove('hidden');

                (res.remedies || []).forEach(r => {
                    const li = document.createElement('li');
                    li.textContent = r;
                    remList.appendChild(li);
                });
                (res.precautions || []).forEach(p => {
                    const li = document.createElement('li');
                    li.textContent = p;
                    preList.appendChild(li);
                });

            } else {
                // Yield View Restoration
                document.getElementById('ySummary').classList.remove('hidden');
                document.getElementById('yAnalytics').classList.remove('hidden');
                // Ensure the placeholder is hidden
                const yRows = document.getElementById('yRows');
                yRows.innerHTML = '';

                document.getElementById('yVal').textContent = `‚Çπ ${res.total_estimated_value.toLocaleString('en-IN')}`;
                document.getElementById('yProfit').textContent = `‚Çπ ${res.total_profit.toLocaleString('en-IN')}`;
                document.getElementById('yScore').textContent = `${res.suitability_score}%`;

                const riskEl = document.getElementById('yRisk');
                const riskBadge = document.getElementById('yRiskBadge');
                riskEl.textContent = res.risk_level;
                if (res.risk_level === 'HIGH') {
                    riskBadge.className = "p-3 rounded-2xl bg-red-500/10 border border-red-500/20 text-center min-w-[120px]";
                    riskEl.className = "text-sm font-black text-red-500";
                } else if (res.risk_level === 'MEDIUM') {
                    riskBadge.className = "p-3 rounded-2xl bg-amber-500/10 border border-amber-500/20 text-center min-w-[120px]";
                    riskEl.className = "text-sm font-black text-amber-500";
                } else {
                    riskBadge.className = "p-3 rounded-2xl bg-green-500/10 border border-green-500/20 text-center min-w-[120px]";
                    riskEl.className = "text-sm font-black text-green-500";
                }

                const rows = document.getElementById('yRows');
                rows.innerHTML = '';
                res.predictions.forEach(p => {
                    const card = document.createElement('div');
                    card.className = "p-6 rounded-3xl bg-white/5 border border-white/10 hover:bg-white/10 transition-all group";
                    card.innerHTML = `
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <p class="text-[10px] uppercase font-bold opacity-40 mb-1">${p.crop_type}</p>
                                <p class="text-xl font-black">${p.predicted_yield_tons} <span class="text-xs opacity-40">TONS</span></p>
                            </div>
                            <div class="text-right">
                                <p class="text-[9px] uppercase font-bold text-green-500">${p.roi}% ROI</p>
                                <p class="text-xs font-bold text-blue-400">‚Çπ ${(p.market_price_est / 1000).toFixed(1)}K</p>
                            </div>
                        </div>
                        <div class="space-y-2">
                             <div class="flex justify-between text-[9px] font-bold opacity-30 uppercase">
                                <span>Yield/Acre</span>
                                <span>Break-even</span>
                             </div>
                             <div class="flex justify-between text-xs font-bold">
                                <span>${p.yield_per_acre} T</span>
                                <span>${p.break_even_tons} T</span>
                             </div>
                        </div>
                    `;
                    rows.appendChild(card);
                });

                const insList = document.getElementById('insightList');
                insList.innerHTML = '';
                (res.insights || []).forEach(ins => {
                    const li = document.createElement('li');
                    li.className = "flex items-start gap-3 p-3 rounded-2xl bg-slate-50 dark:bg-slate-800/50 border border-transparent hover:border-blue-500/30 transition-all";
                    li.innerHTML = `<i class="fas fa-circle-check mt-1 text-blue-500 shadow-lg shadow-blue-500/20"></i> <span class="text-xs font-medium leading-relaxed">${ins}</span>`;
                    insList.appendChild(li);
                });

                window.lastFactors = res.factors;
                renderYieldCharts(res.charts, res.predictions.map(p => p.crop_type));
            }
        }

        function showValidationError(msg) {
            document.getElementById('errorMessage').textContent = msg;
            document.getElementById('errorOverlay').classList.remove('hidden');
        }

        // Real-time Input Validation
        const yForm = document.getElementById('yForm');
        yForm.querySelectorAll('input[type="number"]').forEach(input => {
            input.addEventListener('input', function () {
                const val = parseFloat(this.value);
                const min = parseFloat(this.min);
                const max = parseFloat(this.max);
                const label = this.previousElementSibling?.textContent?.split('[')[0].trim() || "Field";

                if (!isNaN(val) && (val < min || val > max)) {
                    showValidationError(`Range exceeded for ${label}. Please enter a value between ${min} and ${max}.`);
                    this.value = ''; // Auto-clear the invalid input
                }
            });
        });

        // AUTH LOGIC
        function toggleAuthModal() {
            if (window.isLoggedIn) {
                toggleUserMenu();
                return;
            }
            const modal = document.getElementById('authModal');
            if (modal.classList.contains('hidden')) {
                modal.classList.remove('hidden');
                setTimeout(() => document.body.classList.add('auth-active'), 10);
            } else {
                closeAuthModal();
            }
        }

        function closeAuthModal() {
            document.body.classList.remove('auth-active');
            setTimeout(() => {
                document.getElementById('authModal').classList.add('hidden');
            }, 300);
        }

        function showLocationModal() {
            const modal = document.getElementById('locationModal');
            modal.classList.remove('hidden');
            setTimeout(() => document.body.classList.add('location-active'), 10);
        }

        function closeLocationModal() {
            const modal = document.getElementById('locationModal');
            document.body.classList.remove('location-active');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }

        function useCurrentLocation() {
            if ("geolocation" in navigator) {
                navigator.geolocation.getCurrentPosition(function (position) {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;
                    localStorage.setItem('aq_location', JSON.stringify({ lat, lon, type: 'gps' }));
                    alert("üìç GPS Coordinates Locked: Optimizing Mandi Hubs...");
                    loadNearbyExperts();
                    closeLocationModal();
                }, function (error) {
                    alert("Location Access Denied. Please enter your location manually.");
                });
            } else {
                alert("Geolocation is not supported by this browser.");
            }
        }

        function saveManualLocation() {
            const loc = document.getElementById('manualLocation').value.trim();
            if (!loc) {
                alert("Please enter a valid town or APMC name.");
                return;
            }
            localStorage.setItem('aq_location', JSON.stringify({ name: loc, type: 'manual' }));
            alert(`‚úÖ Hub set to: ${loc}. Updating Market Pulse...`);
            updateMandiDisplay(loc); // New helper
            loadNearbyExperts();
            closeLocationModal();
        }

        function updateMandiDisplay(loc) {
            const title = document.querySelector('#marketHubTitle');
            if (title) title.innerHTML = `<i class="fas fa-map-location-dot text-blue-600"></i> Local Mandi: ${loc}`;

            // Sync Mandi Names
            document.querySelectorAll('.mandi-name').forEach((el, i) => {
                if (i === 0) el.innerText = `${loc} APMC Hub`;
            });

            // Mock price updates
            document.querySelectorAll('.mandi-price-main').forEach(p => {
                const base = parseInt(p.innerText.replace('‚Çπ ', '').replace(',', ''));
                const fluctuation = Math.floor(Math.random() * 200) - 100;
                p.innerText = `‚Çπ ${(base + fluctuation).toLocaleString('en-IN')}`;
            });
        }

        function toggleUserMenu() {
            document.getElementById('userMenu').classList.toggle('hidden');
        }

        function toggleAuthView(view = 'login') {
            const l = document.getElementById('loginForm');
            const r = document.getElementById('regForm');
            const title = document.getElementById('authTitle');

            l.classList.add('hidden');
            r.classList.add('hidden');

            if (view === 'reg') {
                r.classList.remove('hidden');
                title.textContent = "Join Us";
            } else {
                l.classList.remove('hidden');
                title.textContent = "Login";
            }
        }

        async function login(e) {
            const btn = e.currentTarget;
            const originalText = btn.innerHTML;
            const username = document.getElementById('lUser').value.trim();
            const password = document.getElementById('lPass').value.trim();

            if (!username || !password) {
                showValidationError("Security Alert: All identity parameters must be provided.");
                return;
            }

            try {
                btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> AUTHENTICATING...';
                btn.disabled = true;

                const res = await fetch('/api/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                }).then(r => r.json());

                if (res.error) {
                    showValidationError(res.error);
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                } else {
                    localStorage.setItem('aq_user', JSON.stringify(res.user));
                    await checkAuthState();
                    closeAuthModal();
                    showLocationModal();
                }
            } catch (e) {
                showValidationError("Network Integrity Error: Failed to link with authentication hub.");
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        async function register() {
            const username = document.getElementById('rUser').value.trim();
            const email = document.getElementById('rEmail').value.trim();
            const phone = document.getElementById('rPhone').value.trim();
            const password = document.getElementById('rPass').value.trim();

            if (!username || !email || !phone || !password) {
                showValidationError("Security Check: All registry directives must be filled.");
                return;
            }

            try {
                const res = await fetch('/api/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, email, phone, password })
                }).then(r => r.json());

                if (res.error) {
                    showValidationError(res.error);
                } else {
                    alert("Registry Complete! Access the hub with your credentials.");
                    toggleAuthView('login');
                }
            } catch (e) {
                showValidationError("Registry Failure: Failed to uplink your credentials.");
            }
        }

        // EXPERT CORNER LOGIC
        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const msg = input.value.trim();
            if (!msg) return;

            const chatArea = document.getElementById('chatMessages');

            // Add user message
            chatArea.innerHTML += `
                <div class="flex gap-4 justify-end message-fade-in">
                    <div class="bg-blue-600 text-white p-5 rounded-3xl rounded-tr-none max-w-[85%] shadow-lg shadow-blue-600/10">
                        <p class="text-sm font-medium leading-relaxed">${msg}</p>
                    </div>
                    <div class="w-10 h-10 rounded-xl bg-slate-900 text-white flex items-center justify-center text-xs flex-shrink-0 font-black">USER</div>
                </div>
            `;
            input.value = '';
            chatArea.scrollTop = chatArea.scrollHeight;

            // Add loading bot message
            const botId = 'bot-' + Date.now();
            chatArea.innerHTML += `
                <div class="flex gap-4" id="${botId}">
                    <div class="w-10 h-10 rounded-full bg-blue-100 dark:bg-blue-900/30 text-blue-600 flex items-center justify-center text-sm flex-shrink-0">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="bg-slate-50 dark:bg-slate-800/50 p-5 rounded-3xl rounded-tl-none max-w-[85%] border border-slate-100 dark:border-white/5">
                        <p class="text-sm font-medium leading-relaxed italic opacity-50">AI Doctor is analyzing...</p>
                    </div>
                </div>
            `;
            chatArea.scrollTop = chatArea.scrollHeight;

            // Add Scan Context to request
            const chatPayload = { message: msg };
            if (window.lastScanResult) {
                chatPayload.context = {
                    crop_type: window.lastScanResult.crop_type,
                    health_status: window.lastScanResult.health_status,
                    disease_name: window.lastScanResult.disease_name
                };
            }

            try {
                const res = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(chatPayload)
                }).then(r => r.json());

                const botMsgDiv = document.getElementById(botId).querySelector('div:last-child');
                if (res.error) {
                    botMsgDiv.innerHTML = `<p class="text-sm font-medium text-red-500">${res.error}</p>`;
                } else {
                    botMsgDiv.innerHTML = `<p class="text-sm font-medium leading-relaxed">${res.response.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>')}</p>`;
                }
            } catch (e) {
                document.getElementById(botId).querySelector('div:last-child').innerHTML = `<p class="text-sm font-medium text-red-500">System Link Failure.</p>`;
            }
            chatArea.scrollTop = chatArea.scrollHeight;
        }

        async function loadNearbyExperts() {
            const locData = JSON.parse(localStorage.getItem('aq_location') || '{}');
            const expertList = document.getElementById('expertList');

            try {
                const query = locData.lat ? `?lat=${locData.lat}&lon=${locData.lon}` : '';
                const experts = await fetch('/api/experts' + query).then(r => r.json());

                expertList.innerHTML = experts.map(exp => `
                    <div class="p-4 rounded-3xl bg-slate-50 dark:bg-slate-800/50 border border-transparent hover:border-blue-500/20 transition-all group">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center gap-4">
                                <div class="w-12 h-12 rounded-2xl bg-slate-200 dark:bg-slate-700 overflow-hidden shadow-inner">
                                    <img src="${exp.image}" class="w-full h-full object-cover">
                                </div>
                                <div>
                                    <p class="text-sm font-black text-slate-900 dark:text-white">${exp.name}</p>
                                    <p class="text-[10px] font-bold opacity-50 uppercase mt-0.5">${exp.specialty}</p>
                                </div>
                            </div>
                            <div class="text-right">
                                <p class="text-[10px] font-black text-blue-600">${exp.distance}</p>
                            </div>
                        </div>
                        <div class="flex gap-2 mb-4">
                            <span class="px-3 py-1 bg-amber-500/10 text-amber-600 rounded-full text-[9px] font-black uppercase"><i class="fas fa-star text-[7px]"></i> ${exp.rating}</span>
                            <span class="px-3 py-1 bg-blue-500/10 text-blue-600 rounded-full text-[9px] font-black uppercase">Exp ${exp.experience}</span>
                        </div>
                        <button onclick="consultExpert('${exp.name}', '${exp.specialty}')" 
                            class="w-full h-12 bg-blue-600 text-white rounded-2xl text-[10px] font-black uppercase tracking-widest hover:bg-blue-700 active:scale-95 transition-all shadow-lg shadow-blue-600/10">
                            Consult Expert
                        </button>
                    </div>
                `).join('');
            } catch (e) {
                expertList.innerHTML = '<p class="text-xs opacity-40 p-10 text-center">Unable to load nearby experts.</p>';
            }
        }

        function consultExpert(name, spec) {
            setView('expert');
            const msg = `Hi ${name}, I am a farmer seeking advice on ${spec}. Can you help me review my latest scan and yield data?`;
            document.getElementById('chatInput').value = msg;
            sendChatMessage();
        }

        function launchDecisionSimulator() {
            if (!window.lastYieldPrediction) {
                alert("Please run a Yield Forecast first to provide simulation data!");
                return;
            }
            const crop = window.lastYieldPrediction.crop_type;
            const simulations = [
                { scenario: "50% Drop in Rainfall during Flowering", result: `Risk: High. Recommendation: Increase Mulching and reduce NPK fertilizer by 10% to prevent root burn.`, impact: "-15% Yield" },
                { scenario: "Unseasonal Late Rains", result: `Risk: Moderate. Recommendation: Shift harvest date forward by 10 days. Check for Fungus immediately.`, impact: "+5% Quality Loss" },
                { scenario: "Optimal Nutrient Balancing (PK Boost)", result: `Opportunity: High. Recommendation: Increase Potassium (K) by 15kg/acre.`, impact: "+12% Yield Increase" }
            ];
            const sim = simulations[Math.floor(Math.random() * simulations.length)];

            const overlay = document.createElement('div');
            overlay.className = "fixed inset-0 z-[200] bg-slate-950/90 backdrop-blur-xl flex items-center justify-center p-6";
            overlay.innerHTML = `
                <div class="card p-10 max-w-lg w-full bg-slate-900 border-blue-500/20 shadow-2xl animate-in zoom-in-95 duration-300">
                    <div class="w-16 h-16 rounded-3xl bg-blue-500/10 text-blue-500 flex items-center justify-center text-3xl mb-8">
                        <i class="fas fa-microchip"></i>
                    </div>
                    <h3 class="text-3xl font-black text-white mb-2 uppercase italic tracking-tighter">AI Decision Simulator</h3>
                    <p class="text-xs font-bold text-blue-500 uppercase tracking-widest mb-8">Scenario Analysis for ${crop.toUpperCase()}</p>
                    
                    <div class="space-y-6 text-white mb-10">
                        <div class="p-5 rounded-2xl bg-white/5 border border-white/10">
                            <p class="text-[10px] font-black uppercase opacity-40 mb-2">Active Scenario</p>
                            <p class="text-sm font-bold text-amber-500">${sim.scenario}</p>
                        </div>
                        <div>
                            <p class="text-[10px] font-black uppercase opacity-40 mb-3 ml-1">AI Recommendation</p>
                            <p class="text-sm font-medium leading-relaxed opacity-80">${sim.result}</p>
                        </div>
                        <div class="flex justify-between items-center pt-6 border-t border-white/5">
                            <p class="text-[10px] font-black uppercase opacity-40">Projected Impact</p>
                            <p class="text-sm font-black text-blue-500">${sim.impact}</p>
                        </div>
                    </div>
                    
                    <button onclick="this.parentElement.parentElement.remove()" 
                        class="w-full py-4 bg-blue-600 text-white rounded-2xl font-black text-xs uppercase tracking-widest shadow-xl shadow-blue-600/30">
                        Close Analysis
                    </button>
                </div>
            `;
            document.body.appendChild(overlay);
        }


        async function logout() {
            await fetch('/api/logout');
            localStorage.removeItem('aq_user');
            checkAuthState();
            location.reload();
        }

        async function checkAuthState() {
            try {
                const res = await fetch('/api/auth/status').then(r => r.json());
                if (res.isLoggedIn) {
                    window.isLoggedIn = true;
                    localStorage.setItem('aq_user', JSON.stringify(res.user));
                    document.getElementById('userName').textContent = res.user.full_name || res.user.username;
                } else {
                    window.isLoggedIn = false;
                    localStorage.removeItem('aq_user');
                    document.getElementById('userName').textContent = "Login / Join";
                }
            } catch (e) {
                console.error("Auth Status Check Failed");
                window.isLoggedIn = false;
                document.getElementById('userName').textContent = "Login / Join";
            }
        }

        /* ======= SETTINGS LOGIC ======= */
        const settingsSchema = {
            'Personal Information': { fields: ['Full Name', 'Email', 'Phone'] },
            'Farm Details': { fields: ['Farm Name', 'Location', 'Land Size (Acres)', 'Primary Crops'] },
            'Language Preference': { fields: ['Language'], type: 'select', options: ['English', 'Hindi', 'Tamil'] },

            'Disease Outbreak Alerts': { fields: ['SMS Alerts', 'Push Notifications', 'Email Alerts'], type: 'toggle' },
            'Weather Warnings': { fields: ['Rain Alerts', 'Drought Alerts', 'Frost Alerts'], type: 'toggle' },
            'Mandi Price Tracking': { fields: ['Price Drop Alerts', 'Price Hike Alerts', 'Daily Summary'], type: 'toggle' },

            'Default Crop Profile': { fields: ['Primary Crop', 'Secondary Crop'] },
            'Planting Calendar': { fields: ['Season Starts (Month)'], type: 'select', options: ['January', 'March', 'June', 'September'] },
            'Local Mandi & Units': { fields: ['Currency'], type: 'select', options: ['‚Çπ INR', '$ USD'] },

            'Data Privacy Controls': { fields: ['Share Location with Experts', 'Participate in Research Data'], type: 'toggle' },
            'Export Farm Data': { type: 'action', action: 'export' },
            'Help & Support': { type: 'action', action: 'support' }
        };

        let currentSettings = {};

        async function initSettings() {
            try {
                // Fetch existing from backend
                const res = await fetch('/api/settings', { headers: { 'Authorization': 'Bearer ' + localStorage.getItem('token') } });
                if (res.ok) {
                    const data = await res.json();
                    currentSettings = data.settings || {};
                }
            } catch (e) {
                console.error('Offline - cannot load settings');
            }

            // List of settings keys in the exact order they appear in the HTML
            const categoryKeys = [
                'Personal Information', 'Farm Details', 'Language Preference',
                'Disease Outbreak Alerts', 'Weather Warnings', 'Mandi Price Tracking',
                'Default Crop Profile', 'Planting Calendar', 'Local Mandi & Units',
                'Data Privacy Controls', 'Export Farm Data', 'Help & Support'
            ];

            // Bind click events using stable indexing instead of translated text content
            document.querySelectorAll('#view-settings .cursor-pointer').forEach((el, index) => {
                el.addEventListener('click', (e) => {
                    if (index < categoryKeys.length) {
                        openSettingsModal(categoryKeys[index]);
                    }
                });
            });
        }

        function previewLanguage(index) {
            // 0 = English, 1 = Hindi, 2 = Tamil
            const codes = ['en', 'hi', 'ta'];
            const code = codes[index] || 'en';

            // Clear existing cookies to prevent desyncs
            document.cookie = 'googtrans=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
            document.cookie = `googtrans=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/; domain=${location.hostname}`;

            // Set new cookies instantly
            document.cookie = `googtrans=/en/${code}; path=/`;
            document.cookie = `googtrans=/en/${code}; path=/; domain=${location.hostname}`;

            // Force a hard reload to ensure Google Translate catches the cookie instantly
            location.reload();
        }

        function openSettingsModal(category) {
            if (!settingsSchema[category]) return;

            const schema = settingsSchema[category];
            const formContainer = document.getElementById('settingsModalForm');

            // Map the English category back to the localized heading for display
            let localizedTitle = category;
            try {
                const categoryKeys = [
                    'Personal Information', 'Farm Details', 'Language Preference',
                    'Disease Outbreak Alerts', 'Weather Warnings', 'Mandi Price Tracking',
                    'Default Crop Profile', 'Planting Calendar', 'Local Mandi & Units',
                    'Data Privacy Controls', 'Export Farm Data', 'Help & Support'
                ];
                const index = categoryKeys.indexOf(category);
                if (index !== -1) {
                    localizedTitle = document.querySelectorAll('#view-settings .cursor-pointer p.font-bold')[index].textContent.trim();
                }
            } catch (e) { }

            document.getElementById('settingsModalTitle').textContent = localizedTitle;
            formContainer.innerHTML = '';
            window.activeSettingsCategory = category;

            if (schema.type === 'action') {
                if (schema.action === 'export') {
                    alert('Exporting your farm data as CSV...');
                    return;
                } else if (schema.action === 'support') {
                    alert('Redirecting to AgriQuest 24/7 Expert Support center...');
                    return;
                }
            }

            schema.fields.forEach(field => {
                const safeKey = category.replace(/\s+/g, '_') + '_' + field.replace(/\s+/g, '_');
                const val = currentSettings[safeKey] || '';

                let html = '';
                if (schema.type === 'toggle') {
                    const isChecked = val === 'true' || val === true;
                    html = `
                        <div class="flex justify-between items-center p-3 bg-slate-50 dark:bg-slate-800 rounded-xl">
                            <label class="font-bold text-sm">${field}</label>
                            <input type="checkbox" id="settingInput_${safeKey}" ${isChecked ? 'checked' : ''} class="w-5 h-5 accent-blue-600 cursor-pointer">
                        </div>`;
                } else if (schema.type === 'select') {
                    let optionsHtml = schema.options.map(o => `<option value="${o}" ${val === o ? 'selected' : ''}>${o}</option>`).join('');
                    let onChangeHTML = field === 'Language' ? 'onchange="previewLanguage(this.selectedIndex)"' : '';
                    html = `
                        <div class="flex flex-col gap-1">
                            <label class="text-xs font-bold opacity-60 uppercase">${field}</label>
                            <select id="settingInput_${safeKey}" ${onChangeHTML} class="p-3 rounded-xl bg-slate-100 dark:bg-slate-800 border-none outline-none focus:ring-2 ring-blue-500 font-bold">
                                ${optionsHtml}
                            </select>
                        </div>`;
                } else {
                    html = `
                        <div class="flex flex-col gap-1">
                            <label class="text-xs font-bold opacity-60 uppercase">${field}</label>
                            <input type="text" id="settingInput_${safeKey}" value="${val}" class="p-3 rounded-xl bg-slate-100 dark:bg-slate-800 border-none outline-none focus:ring-2 ring-blue-500 font-bold">
                        </div>`;
                }
                formContainer.insertAdjacentHTML('beforeend', html);
            });

            document.getElementById('settingsOverlay').classList.remove('hidden');
        }

        async function saveSettings() {
            if (!window.activeSettingsCategory) return;
            const schema = settingsSchema[window.activeSettingsCategory];
            const updates = {};

            const oldLang = currentSettings['Language_Preference_Language'];

            schema.fields.forEach(field => {
                const safeKey = window.activeSettingsCategory.replace(/\s+/g, '_') + '_' + field.replace(/\s+/g, '_');
                const el = document.getElementById(`settingInput_${safeKey}`);
                if (el) {
                    updates[safeKey] = el.type === 'checkbox' ? el.checked : el.value;
                    currentSettings[safeKey] = updates[safeKey];
                }
            });

            document.getElementById('settingsOverlay').classList.add('hidden');

            // Re-render UI markers if needed
            if (window.activeSettingsCategory === 'Language Preference') {
                const selectedLang = updates['Language_Preference_Language'];

                // Attempt to update the badge visually (might fail if translated, which is fine, page reloads anyway)
                try {
                    const badge = document.querySelector('#view-settings span.bg-blue-100');
                    if (badge) badge.textContent = selectedLang;
                } catch (e) { }

                if (oldLang !== selectedLang) {
                    // Set language cookie for automatic Google Translate
                    const langMap = { 'English': 'en', 'Hindi': 'hi', 'Tamil': 'ta' };
                    const code = langMap[selectedLang] || 'en';

                    // Clear existing cookies to prevent conflicts
                    document.cookie = 'googtrans=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;';
                    document.cookie = `googtrans=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/; domain=${location.hostname}`;

                    // Set precise translation cookies
                    document.cookie = `googtrans=/en/${code}; path=/`;
                    document.cookie = `googtrans=/en/${code}; path=/; domain=${location.hostname}`;

                    location.reload();
                }
            }

            // Sync with actual toggle switches in UI (visual)
            const toggleDivs = document.querySelectorAll('.bg-blue-600.rounded-full');
            // Mocking the sync for now

            try {
                await fetch('/api/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updates)
                });
            } catch (e) {
                console.error("Failed to save settings to server:", e);
            }
        }

        // üõ∞Ô∏è AGRI-RADAR LOGIC
        let radarActive = false;
        function initRadar() {
            if (radarActive) return;
            radarActive = true;

            const pContainer = document.getElementById('radarPoints');
            const feed = document.getElementById('radarFeed');
            feed.innerHTML = ''; // Clear pulse

            // Mock Data
            const threats = [
                { crop: 'maize', disease: 'Common Rust', lat: 45, lon: 30, loc: 'East Zone' },
                { crop: 'tomato', disease: 'Early Blight', lat: 60, lon: 55, loc: 'North Valley' },
                { crop: 'wheat', disease: 'Yellow Rust', lat: 25, lon: 70, loc: 'Central Highs' },
                { crop: 'maize', disease: 'Leaf Blight', lat: 80, lon: 20, loc: 'River Delta' }
            ];

            function addPoint(t) {
                const point = document.createElement('div');
                point.className = `radar-point ${t.crop === 'maize' ? 'text-amber-500' : t.crop === 'tomato' ? 'text-red-500' : 'text-blue-500'}`;
                point.style.left = t.lon + '%';
                point.style.top = t.lat + '%';
                point.style.backgroundColor = 'currentColor';

                const label = document.createElement('div');
                label.className = 'radar-label';
                label.style.left = (t.lon + 2) + '%';
                label.style.top = (t.lat - 2) + '%';
                label.innerHTML = `<span class="text-blue-400">DETECTED:</span> ${t.disease}<br><span class="opacity-50">${t.loc}</span>`;

                pContainer.appendChild(point);
                pContainer.appendChild(label);

                // Add to Feed
                const item = document.createElement('div');
                item.className = "p-4 rounded-2xl bg-slate-50 dark:bg-slate-800/50 border border-transparent hover:border-blue-500/20 transition-all message-fade-in";
                item.innerHTML = `
                    <div class="flex justify-between items-start mb-1">
                        <p class="text-[10px] font-black uppercase text-blue-500">${t.crop}</p>
                        <p class="text-[8px] font-bold opacity-40">JUST NOW</p>
                    </div>
                    <p class="text-xs font-bold">${t.disease} Alert</p>
                    <p class="text-[9px] opacity-60 mt-1"><i class="fas fa-location-dot"></i> Detected in ${t.loc}</p>
                `;
                feed.prepend(item);
                if (feed.children.length > 8) feed.lastElementChild.remove();
            }

            // Initial burst
            threats.forEach((t, i) => setTimeout(() => addPoint(t), i * 1000));

            // Continuous Simulation
            setInterval(() => {
                if (window.activeView !== 'radar') return;
                const crops = ['maize', 'tomato', 'wheat'];
                const diseases = ['Rust', 'Blight', 'Mildew', 'Smut'];
                const newT = {
                    crop: crops[Math.floor(Math.random() * crops.length)],
                    disease: diseases[Math.floor(Math.random() * diseases.length)],
                    lat: 10 + Math.random() * 80,
                    lon: 10 + Math.random() * 80,
                    loc: 'Sector ' + (Math.floor(Math.random() * 99) + 1)
                };
                addPoint(newT);
            }, 8000);
        }

        function filterRadar(type) {
            // Visual feedback
            const btns = document.querySelectorAll('#view-radar button');
            btns.forEach(b => {
                if (b.innerText.toLowerCase().includes(type)) {
                    b.classList.add('bg-blue-600', 'text-white');
                    b.classList.remove('bg-slate-100', 'dark:bg-slate-800');
                } else {
                    b.classList.remove('bg-blue-600', 'text-white');
                    b.classList.add('bg-slate-100', 'dark:bg-slate-800');
                }
            });
            alert(`Filtering Radar Intel for: ${type.toUpperCase()}...`);
        }

        // Add to existing on-load check
        const originalCheckAuth = checkAuthState;
        checkAuthState = async function () {
            await originalCheckAuth();
            if (window.isLoggedIn) {
                initSettings();
            }
        };

        // üå¶Ô∏è LIVE WEATHER LOGIC
        async function updateWeather() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(async (pos) => {
                    const { latitude, longitude } = pos.coords;
                    try {
                        const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${latitude}&longitude=${longitude}&current_weather=true&hourly=relativehumidity_2m,precipitation_probability`);
                        const data = await res.json();
                        const weather = data.current_weather;

                        const tempMap = {
                            0: { icon: 'fa-sun text-amber-500', text: 'Clear Sky' },
                            1: { icon: 'fa-cloud-sun text-amber-500', text: 'Mainly Clear' },
                            2: { icon: 'fa-cloud-sun text-amber-400', text: 'Partly Cloudy' },
                            3: { icon: 'fa-cloud text-slate-400', text: 'Overcast' },
                            45: { icon: 'fa-smog text-slate-300', text: 'Foggy' },
                            48: { icon: 'fa-smog text-slate-300', text: 'Rime Fog' },
                            51: { icon: 'fa-cloud-rain text-blue-400', text: 'Light Drizzle' },
                            61: { icon: 'fa-cloud-showers-heavy text-blue-500', text: 'Light Rain' },
                            80: { icon: 'fa-cloud-showers-water text-blue-600', text: 'Rain Showers' },
                            95: { icon: 'fa-cloud-bolt text-indigo-500', text: 'Thunderstorm' }
                        };

                        const condition = tempMap[weather.weathercode] || { icon: 'fa-cloud-sun text-amber-500', text: 'Local Weather' };

                        // Update Sidebar
                        const sIcon = document.getElementById('side-wIcon');
                        if (sIcon) sIcon.innerHTML = `<i class="fas ${condition.icon} animate-pulse"></i>`;
                        document.getElementById('side-wTemp').textContent = `${Math.round(weather.temperature)}¬∞C`;
                        document.getElementById('side-wLoc').textContent = condition.text;

                        // Update Dashboard
                        document.getElementById('dash-wTemp').textContent = `${Math.round(weather.temperature)}¬∞C`;
                        document.getElementById('dash-wWind').textContent = `${Math.round(weather.windspeed)} km/h`;

                        if (data.hourly) {
                            const hum = data.hourly.relativehumidity_2m[0];
                            const rain = data.hourly.precipitation_probability[0];
                            document.getElementById('side-wHum').textContent = `${hum}%`;
                            document.getElementById('side-wRain').textContent = `${rain}%`;
                            document.getElementById('dash-wHum').textContent = `${hum}%`;
                        }

                        // Get City Name reverse geocoding
                        try {
                            const geoRes = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}`);
                            const geoData = await geoRes.json();
                            const city = geoData.address.city || geoData.address.town || geoData.address.village || 'Nearby';
                            document.getElementById('side-wLoc').innerHTML = `<i class="fas fa-location-dot text-[8px] mr-1"></i> ${city}`;
                        } catch (e) { }

                    } catch (e) { console.error("Weather Fetch Error", e); }
                });
            }
        }

        // üìÑ PDF REPORT GENERATION
        async function downloadPDFReport() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const res = window.lastScanResult;

            if (!res) return alert("Please scan a crop first!");

            doc.setFontSize(22); doc.setTextColor(37, 99, 235);
            doc.text("AgriQuest Diagnostic Report", 20, 30);

            doc.setFontSize(10); doc.setTextColor(100);
            doc.text(`Generated: ${new Date().toLocaleString()}`, 20, 40);
            doc.line(20, 45, 190, 45);

            doc.setFontSize(14); doc.setTextColor(0);
            doc.text(`Crop Type: ${res.crop_type.toUpperCase()}`, 20, 60);

            const isH = res.health_status === 'healthy';
            doc.setTextColor(isH ? 34 : 220, isH ? 197 : 38, isH ? 94 : 38);
            doc.text(`Health Status: ${res.health_status.toUpperCase()}`, 20, 70);

            doc.setTextColor(0); doc.text(`Confidence: ${(res.confidence * 100).toFixed(1)}%`, 20, 80);

            if (res.disease_name) {
                doc.setFontSize(16); doc.setTextColor(185, 28, 28);
                doc.text(`Diagnosis: ${res.disease_name}`, 20, 95);
            }

            const getItems = (id) => Array.from(document.querySelectorAll(`${id} li`)).map(li => li.innerText);
            const remedies = getItems('#remedyList');
            const precautions = getItems('#precautionList');

            doc.setFontSize(14); doc.setTextColor(37, 99, 235);
            doc.text("Action Plan & Remedies", 20, 115);
            doc.setFontSize(10); doc.setTextColor(50);
            let y = 125;
            remedies.forEach(r => { doc.text(`‚Ä¢ ${r}`, 25, y); y += 7; });

            y += 5;
            doc.setFontSize(14); doc.setTextColor(217, 119, 6);
            doc.text("Safety Precautions", 20, y);
            doc.setFontSize(10); y += 10;
            precautions.forEach(p => { doc.text(`‚Ä¢ ${p}`, 25, y); y += 7; });

            doc.save(`AgriQuest_Report_${res.crop_type}.pdf`);
        }

        // üß† SMART AUTO-DETECT
        async function detectAndAnalyze() {
            const btn = document.getElementById('autoBtn');
            const crops = ['maize', 'wheat', 'tomato'];
            let bestMatch = null;
            let bestConf = 0;

            btn.innerHTML = `<i class="fas fa-spinner animate-spin"></i> Identifying Crop...`;
            btn.disabled = true;

            try {
                const fileSource = scanMode === 'upload' ? document.getElementById('img').files[0] : capturedBlob;
                if (!fileSource) {
                    alert(`Please ${scanMode === 'upload' ? 'upload' : 'capture'} a photo first!`);
                } else {
                    for (const crop of crops) {
                        const formData = new FormData();
                        formData.append('crop_type', crop);
                        formData.append('file', fileSource, 'analysis.jpg');

                        const res = await fetch('/api/predict', { method: 'POST', body: formData }).then(r => r.json());
                        if (!res.error && res.confidence > bestConf && !res.note?.includes('Others')) {
                            bestConf = res.confidence;
                            bestMatch = { crop, res };
                        }
                    }
                }

                if (bestMatch) {
                    document.getElementById('cropType').value = bestMatch.crop;
                    window.lastScanResult = bestMatch.res;
                    // Trigger normal render logic
                    const res = bestMatch.res;
                    document.getElementById('loading').classList.add('hidden');
                    document.getElementById('results').classList.remove('hidden');
                    const h = res.health_status === 'healthy';
                    document.getElementById('stText').textContent = res.health_status;
                    document.getElementById('stText').className = h ? "text-5xl font-black text-green-500 uppercase" : "text-5xl font-black text-white uppercase";
                    document.getElementById('stCard').className = h ? "p-10 rounded-[36px] bg-green-500/10 border border-green-500/20 text-center" : "p-10 rounded-[36px] bg-red-600 text-white shadow-xl text-center";
                    document.getElementById('cfText').textContent = `${(res.confidence * 100).toFixed(1)}%`;

                    if (!h) {
                        document.getElementById('disBox').classList.remove('hidden');
                        document.getElementById('disName').textContent = res.disease_name;
                    } else { document.getElementById('disBox').classList.add('hidden'); }

                    populateRemedies(res);
                    alert(`Smart AI detected: ${bestMatch.crop.toUpperCase()} üåø`);
                } else if (fileSource) {
                    alert("Could not clearly identify crop. Please select manually.");
                }
            } catch (e) { console.error(e); }

            btn.innerHTML = `<i class="fas fa-magic text-blue-500"></i> Smart AI: Auto-Detect Crop`;
            btn.disabled = false;
        }

        // üåê LANGUAGE HUB
        function previewLanguage(index) {
            const langMap = ['en', 'hi', 'ta'];
            changeLanguage(langMap[index] || 'en');
        }

        function changeLanguage(langCode) {
            const overlay = document.getElementById('langOverlay');
            if (overlay) overlay.classList.remove('hidden');

            const select = document.querySelector('.goog-te-combo');
            if (select) {
                select.value = langCode;
                select.dispatchEvent(new Event('change'));

                // Visual feedback on buttons
                const btns = document.querySelectorAll('header .gap-2 button');
                btns.forEach(b => {
                    const bCode = b.getAttribute('onclick')?.match(/'([^']+)'/)?.[1];
                    if (bCode === langCode) {
                        b.classList.add('bg-white', 'dark:bg-slate-700', 'shadow-sm');
                    } else {
                        b.classList.remove('bg-white', 'dark:bg-slate-700', 'shadow-sm');
                    }
                });

                setTimeout(() => {
                    if (overlay) overlay.classList.add('hidden');
                }, 1500);
            } else {
                alert("Translation Engine is still warming up. Please wait 2 seconds...");
                if (overlay) overlay.classList.add('hidden');
            }
        }

        const lDataStart = JSON.parse(localStorage.getItem('aq_location') || '{}');
        if (lDataStart.name) updateMandiDisplay(lDataStart.name);

        updateWeather();
        checkAuthState();
        updateThemeUI();
    </script>

    <!-- INVISIBLE TRANSLATION WIDGET -->
    <style>
        body {
            top: 0 !important;
        }

        .goog-te-banner-frame {
            display: none !important;
        }

        .skiptranslate {
            display: none !important;
        }

        #google_translate_element {
            display: none !important;
        }
    </style>
    <div id="google_translate_element"></div>
    <script type="text/javascript">
        function googleTranslateElementInit() {
            new google.translate.TranslateElement({
                pageLanguage: 'en',
                includedLanguages: 'en,hi,ta',
                layout: google.translate.TranslateElement.InlineLayout.SIMPLE,
                autoDisplay: false
            }, 'google_translate_element');
        }
    </script>
    <script type="text/javascript"
        src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>

    <!-- Language Processing Overlay -->
    <div id="langOverlay"
        class="hidden fixed inset-0 z-[1000] flex items-center justify-center bg-slate-950/80 backdrop-blur-sm">
        <div class="flex flex-col items-center gap-6">
            <div
                class="w-20 h-20 rounded-[32px] bg-blue-600 flex items-center justify-center text-3xl text-white shadow-2xl shadow-blue-500/50">
                <i class="fas fa-language animate-bounce"></i>
            </div>
            <div class="text-center">
                <h4 class="text-2xl font-black text-white uppercase tracking-tight mb-2">Translating Interface</h4>
                <p class="text-[10px] font-bold text-blue-400 uppercase tracking-[4px] animate-pulse">Syncing AI
                    Models...</p>
            </div>
        </div>
    </div>

</body>

</html>